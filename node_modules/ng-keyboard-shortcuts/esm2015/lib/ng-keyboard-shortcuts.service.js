import * as tslib_1 from "tslib";
var KeyboardShortcutsService_1;
import { Injectable } from "@angular/core";
import { _KEYCODE_MAP, _MAP, _SHIFT_MAP, modifiers } from "./keys";
import { BehaviorSubject, fromEvent, Subject, throwError, timer, of } from "rxjs";
import { catchError, filter, map, repeat, scan, switchMap, takeUntil, tap, throttle } from "rxjs/operators";
import { allPass, any, difference, identity, isFunction, isNill, maxArrayProp } from "./utils";
import * as i0 from "@angular/core";
/**
 * @ignore
 * @type {number}
 */
let guid = 0;
let KeyboardShortcutsService = KeyboardShortcutsService_1 = class KeyboardShortcutsService {
    /**
     * @ignore
     */
    constructor() {
        /**
         * Parsed shortcuts
         * for each key create a predicate function
         */
        this._shortcuts = [];
        this._sequences = [];
        /**
         * Throttle the keypress event.
         */
        this.throttleTime = 0;
        this._pressed = new Subject();
        /**
         * Streams of pressed events, can be used instead or with a command.
         */
        this.pressed$ = this._pressed.asObservable();
        /**
         * Disable all keyboard shortcuts
         */
        this.disabled = false;
        this._shortcutsSub = new BehaviorSubject([]);
        this.shortcuts$ = this._shortcutsSub
            .asObservable()
            .pipe(filter(shortcuts => !!shortcuts.length));
        this._ignored = ["INPUT", "TEXTAREA", "SELECT"];
        /**
         * @ignore
         * Subscription for on destroy.
         */
        this.subscriptions = [];
        /**
         * @ignore
         * @param shortcut
         */
        this.isAllowed = (shortcut) => {
            const target = shortcut.event.target;
            if (target === shortcut.target) {
                return true;
            }
            if (shortcut.allowIn.length) {
                return !difference(this._ignored, shortcut.allowIn).includes(target.nodeName);
            }
            return !this._ignored.includes(target.nodeName);
        };
        /**
         * @ignore
         * @param event
         */
        this.mapEvent = event => {
            return this._shortcuts
                .map(shortcut => Object.assign({}, shortcut, {
                predicates: any(identity, shortcut.predicates.map((predicates) => allPass(predicates)(event))),
                event: event
            }))
                .filter(shortcut => shortcut.predicates)
                .reduce((acc, shortcut) => (acc.priority > shortcut.priority ? acc : shortcut), {
                priority: 0
            });
        };
        /**
         * @ignore
         */
        this.keydown$ = fromEvent(document, "keydown");
        /**
         * @ignore
         */
        this.keydownCombo$ = this.keydown$.pipe(filter(_ => !this.disabled), map(this.mapEvent), filter((shortcut) => !shortcut.target || shortcut.event.target === shortcut.target), filter((shortcut) => isFunction(shortcut.command)), filter(this.isAllowed), tap(shortcut => !shortcut.preventDefault || shortcut.event.preventDefault()), throttle(shortcut => timer(shortcut.throttleTime)), tap(shortcut => shortcut.command({ event: shortcut.event, key: shortcut.key })), tap(shortcut => this._pressed.next({ event: shortcut.event, key: shortcut.key })), catchError(error => throwError(error)));
        /**
         * @ignore
         */
        this.timer$ = new Subject();
        /**
         * @ignore
         */
        this.resetCounter$ = this.timer$
            .asObservable()
            .pipe(switchMap(() => timer(KeyboardShortcutsService_1.TIMEOUT_SEQUENCE)));
        /**
         * @ignore
         */
        this.keydownSequence$ = this.shortcuts$.pipe(map(shortcuts => shortcuts.filter(shortcut => shortcut.isSequence)), switchMap(sequences => this.keydown$.pipe(map(event => {
            return {
                event,
                sequences
            };
        }), tap(this.timer$))), scan((acc, arg) => {
            let { event } = arg;
            const currentLength = acc.events.length;
            const sequences = currentLength ? acc.sequences : arg.sequences;
            let [characters] = this.characterFromEvent(event);
            characters = Array.isArray(characters) ? characters : [characters];
            const result = sequences
                .map(sequence => {
                const sequences = sequence.sequence.filter(seque => characters.some((key) => seque[currentLength] === key));
                const partialMatch = sequences.length > 0;
                if (sequence.fullMatch) {
                    return sequence;
                }
                return Object.assign({}, sequence, { sequence: sequences, partialMatch, event: event, fullMatch: partialMatch &&
                        this.isFullMatch({ command: sequence, events: acc.events }) });
            })
                .filter(sequences => sequences.partialMatch || sequences.fullMatch);
            let [match] = result;
            if (!match || this.modifiersOn(event)) {
                return { events: [], sequences: this._sequences };
            }
            /*
             * handle case of "?" sequence and "? a" sequence
             * need to determine which one to trigger.
             * if both match, we pick the longer one (? a) in this case.
             */
            const guess = maxArrayProp('priority', result);
            if (result.length > 1 && guess.fullMatch) {
                return { events: [], command: guess, sequences: this._sequences };
            }
            if (result.length > 1) {
                return { events: [...acc.events, event], command: result, sequences: result };
            }
            if (match.fullMatch) {
                return { events: [], command: match, sequences: this._sequences };
            }
            return { events: [...acc.events, event], command: result, sequences: result };
        }, { events: [], sequences: [] }), switchMap(({ command }) => {
            if (Array.isArray(command)) {
                /*
                 * Add a timer to handle the case where for example:
                 * a sequence "?" is registered and "? a" is registered as well
                 * if the user does not hit any key for 500ms, the single sequence will trigger
                 * if any keydown event occur, this timer will reset, given a chance to complete
                 * the full sequence (? a) in this case.
                 * This delay only occurs when single key sequence is the beginning of another sequence.
                 */
                return timer(500).pipe(map(() => ({ command: command.filter(command => command.fullMatch)[0] })));
            }
            return of({ command });
        }), filter(({ command }) => command && command.fullMatch), map(({ command }) => command), filter((shortcut) => isFunction(shortcut.command)), filter(this.isAllowed), tap(shortcut => !shortcut.preventDefault || shortcut.event.preventDefault()), throttle(shortcut => timer(shortcut.throttleTime)), tap(shortcut => shortcut.command({ event: shortcut.event, key: shortcut.key })), tap(shortcut => this._pressed.next({ event: shortcut.event, key: shortcut.key })), takeUntil(this.resetCounter$), repeat());
        /**
         * @ignore
         * transforms a shortcut to:
         * a predicate function
         */
        this.getKeys = (keys) => {
            return keys
                .map(key => key.trim().toLowerCase())
                .filter(key => key !== "+")
                .map(key => {
                // for modifiers like control key
                // look for event['ctrlKey']
                // otherwise use the keyCode
                if (modifiers.hasOwnProperty(key)) {
                    return event => !!event[modifiers[key]];
                }
                return event => {
                    let [characters, shiftKey] = this.characterFromEvent(event);
                    characters = Array.isArray(characters) ? characters : [characters];
                    return characters.some(char => {
                        if (char === key && shiftKey) {
                            return true;
                        }
                        return key === char;
                    });
                };
            });
        };
        this.subscriptions.push(this.keydownSequence$.subscribe(), this.keydownCombo$.subscribe());
    }
    /**
     * @ignore
     * @param command
     * @param events
     */
    isFullMatch({ command, events }) {
        if (!command) {
            return false;
        }
        return command.sequence.some(sequence => {
            return sequence.length === events.length + 1;
        });
    }
    /**
     * @ignore
     */
    get shortcuts() {
        return this._shortcuts;
    }
    /**
     * @ignore
     * @param event
     */
    _characterFromEvent(event) {
        if (typeof event.which !== "number") {
            event.which = event.keyCode;
        }
        // for non keypress events the special maps are needed
        if (_MAP[event.which]) {
            return [_MAP[event.which], event.shiftKey];
        }
        if (_KEYCODE_MAP[event.which]) {
            return [_KEYCODE_MAP[event.which], event.shiftKey];
        }
        // if it is not in the special map
        // with keydown and keyup events the character seems to always
        // come in as an uppercase character whether you are pressing shift
        // or not.  we should make sure it is always lowercase for comparisons
        return [String.fromCharCode(event.which).toLowerCase(), event.shiftKey];
    }
    characterFromEvent(event) {
        let [key, shiftKey] = this._characterFromEvent(event);
        if (shiftKey && _SHIFT_MAP[key]) {
            return [_SHIFT_MAP[key], shiftKey];
        }
        return [key, shiftKey];
    }
    /**
     * @ignore
     * Remove subscription.
     */
    ngOnDestroy() {
        this.subscriptions.forEach(sub => sub.unsubscribe());
    }
    /**
     * @ignore
     * @param shortcuts
     */
    isSequence(shortcuts) {
        return !shortcuts.some(shortcut => shortcut.includes("+"));
    }
    /**
     * Add new shortcut/s
     */
    add(shortcuts) {
        shortcuts = Array.isArray(shortcuts) ? shortcuts : [shortcuts];
        const commands = this.parseCommand(shortcuts);
        commands.forEach(command => {
            if (command.isSequence) {
                this._sequences.push(command);
                return;
            }
            this._shortcuts.push(command);
        });
        setTimeout(() => {
            this._shortcutsSub.next([...this._shortcuts, ...this._sequences]);
        });
        return commands.map(command => command.id);
    }
    /**
     * Remove a command based on key or array of keys.
     * can be used for cleanup.
     * @returns
     * @param ids
     */
    remove(ids) {
        ids = Array.isArray(ids) ? ids : [ids];
        this._shortcuts = this._shortcuts.filter(shortcut => !ids.includes(shortcut.id));
        this._sequences = this._sequences.filter(shortcut => !ids.includes(shortcut.id));
        setTimeout(() => {
            this._shortcutsSub.next([...this._shortcuts, ...this._sequences]);
        });
        return this;
    }
    /**
     * Returns an observable of keyboard shortcut filtered by a specific key.
     * @param key - the key to filter the observable by.
     */
    select(key) {
        return this.pressed$.pipe(filter(({ event, key: eventKeys }) => {
            eventKeys = Array.isArray(eventKeys) ? eventKeys : [eventKeys];
            return !!eventKeys.find(eventKey => eventKey === key);
        }));
    }
    /**
     * @ignore
     * @param event
     */
    modifiersOn(event) {
        return ["metaKey", "altKey", "ctrlKey"].some(mod => event[mod]);
    }
    /**
     * @ignore
     * Parse each command using getKeys function
     */
    parseCommand(command) {
        const commands = Array.isArray(command) ? command : [command];
        return commands.map(command => {
            const keys = Array.isArray(command.key) ? command.key : [command.key];
            const priority = Math.max(...keys.map(key => key.split(" ").filter(identity).length));
            const predicates = keys.map(key => this.getKeys(key.split(" ").filter(identity)));
            const isSequence = this.isSequence(keys);
            const sequence = isSequence
                ? keys.map(key => key
                    .split(" ")
                    .filter(identity)
                    .map(key => key.trim()))
                : [];
            return Object.assign({}, command, { isSequence, sequence: isSequence ? sequence : [], allowIn: command.allowIn || [], key: keys, id: `${guid++}`, throttle: isNill(command.throttleTime) ? this.throttleTime : command.throttleTime, priority: priority, predicates: predicates });
        });
    }
};
/**
 * @ignore
 * 2000 ms window to allow between key sequences otherwise
 * the sequence will reset.
 */
KeyboardShortcutsService.TIMEOUT_SEQUENCE = 1000;
KeyboardShortcutsService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function KeyboardShortcutsService_Factory() { return new KeyboardShortcutsService(); }, token: KeyboardShortcutsService, providedIn: "root" });
KeyboardShortcutsService = KeyboardShortcutsService_1 = tslib_1.__decorate([
    Injectable({
        providedIn: "root"
    }),
    tslib_1.__metadata("design:paramtypes", [])
], KeyboardShortcutsService);
export { KeyboardShortcutsService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmcta2V5Ym9hcmQtc2hvcnRjdXRzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1rZXlib2FyZC1zaG9ydGN1dHMvIiwic291cmNlcyI6WyJsaWIvbmcta2V5Ym9hcmQtc2hvcnRjdXRzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDbkUsT0FBTyxFQUNILGVBQWUsRUFDZixTQUFTLEVBRVQsT0FBTyxFQUVQLFVBQVUsRUFDVixLQUFLLEVBQ0wsRUFBRSxFQUNMLE1BQU0sTUFBTSxDQUFDO0FBTWQsT0FBTyxFQUNILFVBQVUsRUFDVixNQUFNLEVBQ04sR0FBRyxFQUNILE1BQU0sRUFDTixJQUFJLEVBQ0osU0FBUyxFQUNULFNBQVMsRUFDVCxHQUFHLEVBQ0gsUUFBUSxFQUNYLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxNQUFNLFNBQVMsQ0FBQzs7QUFFL0Y7OztHQUdHO0FBQ0gsSUFBSSxJQUFJLEdBQUcsQ0FBQyxDQUFDO0FBS2IsSUFBYSx3QkFBd0IsZ0NBQXJDLE1BQWEsd0JBQXdCO0lBdU9qQzs7T0FFRztJQUNIO1FBek9BOzs7V0FHRztRQUNLLGVBQVUsR0FBcUIsRUFBRSxDQUFDO1FBRWxDLGVBQVUsR0FBcUIsRUFBRSxDQUFDO1FBRTFDOztXQUVHO1FBQ0ssaUJBQVksR0FBRyxDQUFDLENBQUM7UUFFakIsYUFBUSxHQUFHLElBQUksT0FBTyxFQUF1QixDQUFDO1FBRXREOztXQUVHO1FBQ0ksYUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxFQUFFLENBQUM7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LENBQUM7WUFDVCxPQUFPLGtCQUNBLE9BQU8sSUFDVixVQUFVLEVBQ1YsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQ3BDLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTyxJQUFJLEVBQUUsRUFDOUIsR0FBRyxFQUFFLElBQUksRUFDVCxFQUFFLEVBQUUsR0FBRyxJQUFJLEVBQUUsRUFBRSxFQUNmLFFBQVEsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUNqRixRQUFRLEVBQUUsUUFBUSxFQUNsQixVQUFVLEVBQUUsVUFBVSxHQUNQLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0osQ0FBQTtBQTNYRzs7OztHQUlHO0FBQ3FCLHlDQUFnQixHQUFHLElBQUksQ0FBQzs7QUE5QnZDLHdCQUF3QjtJQUhwQyxVQUFVLENBQUM7UUFDUixVQUFVLEVBQUUsTUFBTTtLQUNyQixDQUFDOztHQUNXLHdCQUF3QixDQW9acEM7U0FwWlksd0JBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT25EZXN0cm95IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IF9LRVlDT0RFX01BUCwgX01BUCwgX1NISUZUX01BUCwgbW9kaWZpZXJzIH0gZnJvbSBcIi4va2V5c1wiO1xuaW1wb3J0IHtcbiAgICBCZWhhdmlvclN1YmplY3QsXG4gICAgZnJvbUV2ZW50LFxuICAgIE9ic2VydmFibGUsXG4gICAgU3ViamVjdCxcbiAgICBTdWJzY3JpcHRpb24sXG4gICAgdGhyb3dFcnJvcixcbiAgICB0aW1lcixcbiAgICBvZlxufSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHtcbiAgICBQYXJzZWRTaG9ydGN1dCxcbiAgICBTaG9ydGN1dEV2ZW50T3V0cHV0LFxuICAgIFNob3J0Y3V0SW5wdXRcbn0gZnJvbSBcIi4vbmcta2V5Ym9hcmQtc2hvcnRjdXRzLmludGVyZmFjZXNcIjtcbmltcG9ydCB7XG4gICAgY2F0Y2hFcnJvcixcbiAgICBmaWx0ZXIsXG4gICAgbWFwLFxuICAgIHJlcGVhdCxcbiAgICBzY2FuLFxuICAgIHN3aXRjaE1hcCxcbiAgICB0YWtlVW50aWwsXG4gICAgdGFwLFxuICAgIHRocm90dGxlXG59IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xuaW1wb3J0IHsgYWxsUGFzcywgYW55LCBkaWZmZXJlbmNlLCBpZGVudGl0eSwgaXNGdW5jdGlvbiwgaXNOaWxsLCBtYXhBcnJheVByb3AgfSBmcm9tIFwiLi91dGlsc1wiO1xuXG4vKipcbiAqIEBpZ25vcmVcbiAqIEB0eXBlIHtudW1iZXJ9XG4gKi9cbmxldCBndWlkID0gMDtcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46IFwicm9vdFwiXG59KVxuZXhwb3J0IGNsYXNzIEtleWJvYXJkU2hvcnRjdXRzU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gICAgLyoqXG4gICAgICogUGFyc2VkIHNob3J0Y3V0c1xuICAgICAqIGZvciBlYWNoIGtleSBjcmVhdGUgYSBwcmVkaWNhdGUgZnVuY3Rpb25cbiAgICAgKi9cbiAgICBwcml2YXRlIF9zaG9ydGN1dHM6IFBhcnNlZFNob3J0Y3V0W10gPSBbXTtcblxuICAgIHByaXZhdGUgX3NlcXVlbmNlczogUGFyc2VkU2hvcnRjdXRbXSA9IFtdO1xuXG4gICAgLyoqXG4gICAgICogVGhyb3R0bGUgdGhlIGtleXByZXNzIGV2ZW50LlxuICAgICAqL1xuICAgIHByaXZhdGUgdGhyb3R0bGVUaW1lID0gMDtcblxuICAgIHByaXZhdGUgX3ByZXNzZWQgPSBuZXcgU3ViamVjdDxTaG9ydGN1dEV2ZW50T3V0cHV0PigpO1xuXG4gICAgLyoqXG4gICAgICogU3RyZWFtcyBvZiBwcmVzc2VkIGV2ZW50cywgY2FuIGJlIHVzZWQgaW5zdGVhZCBvciB3aXRoIGEgY29tbWFuZC5cbiAgICAgKi9cbiAgICBwdWJsaWMgcHJlc3NlZCQgPSB0aGlzLl9wcmVzc2VkLmFzT2JzZXJ2YWJsZSgpO1xuXG4gICAgLyoqXG4gICAgICogRGlzYWJsZSBhbGwga2V5Ym9hcmQgc2hvcnRjdXRzXG4gICAgICovXG4gICAgcHJpdmF0ZSBkaXNhYmxlZCA9IGZhbHNlO1xuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKiAyMDAwIG1zIHdpbmRvdyB0byBhbGxvdyBiZXR3ZWVuIGtleSBzZXF1ZW5jZXMgb3RoZXJ3aXNlXG4gICAgICogdGhlIHNlcXVlbmNlIHdpbGwgcmVzZXQuXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgVElNRU9VVF9TRVFVRU5DRSA9IDEwMDA7XG5cbiAgICBwcml2YXRlIF9zaG9ydGN1dHNTdWIgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFBhcnNlZFNob3J0Y3V0W10+KFtdKTtcbiAgICBwdWJsaWMgc2hvcnRjdXRzJCA9IHRoaXMuX3Nob3J0Y3V0c1N1YlxuICAgICAgICAuYXNPYnNlcnZhYmxlKClcbiAgICAgICAgLnBpcGUoZmlsdGVyKHNob3J0Y3V0cyA9PiAhIXNob3J0Y3V0cy5sZW5ndGgpKTtcblxuICAgIHByaXZhdGUgX2lnbm9yZWQgPSBbXCJJTlBVVFwiLCBcIlRFWFRBUkVBXCIsIFwiU0VMRUNUXCJdO1xuXG4gICAgLyoqXG4gICAgICogQGlnbm9yZVxuICAgICAqIFN1YnNjcmlwdGlvbiBmb3Igb24gZGVzdHJveS5cbiAgICAgKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbltdID0gW107XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICogQHBhcmFtIHNob3J0Y3V0XG4gICAgICovXG4gICAgcHJpdmF0ZSBpc0FsbG93ZWQgPSAoc2hvcnRjdXQ6IFBhcnNlZFNob3J0Y3V0KSA9PiB7XG4gICAgICAgIGNvbnN0IHRhcmdldCA9IHNob3J0Y3V0LmV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgaWYgKHRhcmdldCA9PT0gc2hvcnRjdXQudGFyZ2V0KSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2hvcnRjdXQuYWxsb3dJbi5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiAhZGlmZmVyZW5jZSh0aGlzLl9pZ25vcmVkLCBzaG9ydGN1dC5hbGxvd0luKS5pbmNsdWRlcyh0YXJnZXQubm9kZU5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAhdGhpcy5faWdub3JlZC5pbmNsdWRlcyh0YXJnZXQubm9kZU5hbWUpO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICogQHBhcmFtIGV2ZW50XG4gICAgICovXG4gICAgcHJpdmF0ZSBtYXBFdmVudCA9IGV2ZW50ID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Nob3J0Y3V0c1xuICAgICAgICAgICAgLm1hcChzaG9ydGN1dCA9PlxuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oe30sIHNob3J0Y3V0LCB7XG4gICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZXM6IGFueShcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50aXR5LFxuICAgICAgICAgICAgICAgICAgICAgICAgc2hvcnRjdXQucHJlZGljYXRlcy5tYXAoKHByZWRpY2F0ZXM6IGFueSkgPT4gYWxsUGFzcyhwcmVkaWNhdGVzKShldmVudCkpXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50OiBldmVudFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuZmlsdGVyKHNob3J0Y3V0ID0+IHNob3J0Y3V0LnByZWRpY2F0ZXMpXG4gICAgICAgICAgICAucmVkdWNlKChhY2MsIHNob3J0Y3V0KSA9PiAoYWNjLnByaW9yaXR5ID4gc2hvcnRjdXQucHJpb3JpdHkgPyBhY2MgOiBzaG9ydGN1dCksIHtcbiAgICAgICAgICAgICAgICBwcmlvcml0eTogMFxuICAgICAgICAgICAgfSBhcyBQYXJzZWRTaG9ydGN1dCk7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICBwcml2YXRlIGtleWRvd24kID0gZnJvbUV2ZW50KGRvY3VtZW50LCBcImtleWRvd25cIik7XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSBrZXlkb3duQ29tYm8kID0gdGhpcy5rZXlkb3duJC5waXBlKFxuICAgICAgICBmaWx0ZXIoXyA9PiAhdGhpcy5kaXNhYmxlZCksXG4gICAgICAgIG1hcCh0aGlzLm1hcEV2ZW50KSxcbiAgICAgICAgZmlsdGVyKFxuICAgICAgICAgICAgKHNob3J0Y3V0OiBQYXJzZWRTaG9ydGN1dCkgPT5cbiAgICAgICAgICAgICAgICAhc2hvcnRjdXQudGFyZ2V0IHx8IHNob3J0Y3V0LmV2ZW50LnRhcmdldCA9PT0gc2hvcnRjdXQudGFyZ2V0XG4gICAgICAgICksXG4gICAgICAgIGZpbHRlcigoc2hvcnRjdXQ6IFBhcnNlZFNob3J0Y3V0KSA9PiBpc0Z1bmN0aW9uKHNob3J0Y3V0LmNvbW1hbmQpKSxcbiAgICAgICAgZmlsdGVyKHRoaXMuaXNBbGxvd2VkKSxcbiAgICAgICAgdGFwKHNob3J0Y3V0ID0+ICFzaG9ydGN1dC5wcmV2ZW50RGVmYXVsdCB8fCBzaG9ydGN1dC5ldmVudC5wcmV2ZW50RGVmYXVsdCgpKSxcbiAgICAgICAgdGhyb3R0bGUoc2hvcnRjdXQgPT4gdGltZXIoc2hvcnRjdXQudGhyb3R0bGVUaW1lKSksXG4gICAgICAgIHRhcChzaG9ydGN1dCA9PiBzaG9ydGN1dC5jb21tYW5kKHsgZXZlbnQ6IHNob3J0Y3V0LmV2ZW50LCBrZXk6IHNob3J0Y3V0LmtleSB9KSksXG4gICAgICAgIHRhcChzaG9ydGN1dCA9PiB0aGlzLl9wcmVzc2VkLm5leHQoeyBldmVudDogc2hvcnRjdXQuZXZlbnQsIGtleTogc2hvcnRjdXQua2V5IH0pKSxcbiAgICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB0aHJvd0Vycm9yKGVycm9yKSlcbiAgICApO1xuXG4gICAgLyoqXG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIHByaXZhdGUgdGltZXIkID0gbmV3IFN1YmplY3QoKTtcbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSByZXNldENvdW50ZXIkID0gdGhpcy50aW1lciRcbiAgICAgICAgLmFzT2JzZXJ2YWJsZSgpXG4gICAgICAgIC5waXBlKHN3aXRjaE1hcCgoKSA9PiB0aW1lcihLZXlib2FyZFNob3J0Y3V0c1NlcnZpY2UuVElNRU9VVF9TRVFVRU5DRSkpKTtcbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSBrZXlkb3duU2VxdWVuY2UkID0gdGhpcy5zaG9ydGN1dHMkLnBpcGUoXG4gICAgICAgIG1hcChzaG9ydGN1dHMgPT4gc2hvcnRjdXRzLmZpbHRlcihzaG9ydGN1dCA9PiBzaG9ydGN1dC5pc1NlcXVlbmNlKSksXG4gICAgICAgIHN3aXRjaE1hcChzZXF1ZW5jZXMgPT5cbiAgICAgICAgICAgIHRoaXMua2V5ZG93biQucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXF1ZW5jZXNcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICB0YXAodGhpcy50aW1lciQpXG4gICAgICAgICAgICApXG4gICAgICAgICksXG4gICAgICAgIHNjYW4oXG4gICAgICAgICAgICAoYWNjOiB7IGV2ZW50czogYW55W107IGNvbW1hbmQ/OiBhbnk7IHNlcXVlbmNlczogYW55W10gfSwgYXJnOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgeyBldmVudCB9ID0gYXJnO1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRMZW5ndGggPSBhY2MuZXZlbnRzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICBjb25zdCBzZXF1ZW5jZXMgPSBjdXJyZW50TGVuZ3RoID8gYWNjLnNlcXVlbmNlcyA6IGFyZy5zZXF1ZW5jZXM7XG4gICAgICAgICAgICAgICAgbGV0IFtjaGFyYWN0ZXJzXSA9IHRoaXMuY2hhcmFjdGVyRnJvbUV2ZW50KGV2ZW50KTtcbiAgICAgICAgICAgICAgICBjaGFyYWN0ZXJzID0gQXJyYXkuaXNBcnJheShjaGFyYWN0ZXJzKSA/IGNoYXJhY3RlcnMgOiBbY2hhcmFjdGVyc107XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gc2VxdWVuY2VzXG4gICAgICAgICAgICAgICAgICAgIC5tYXAoc2VxdWVuY2UgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VxdWVuY2VzID0gc2VxdWVuY2Uuc2VxdWVuY2UuZmlsdGVyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcXVlID0+IGNoYXJhY3RlcnMuc29tZSgoa2V5KSA9PiBzZXF1ZVtjdXJyZW50TGVuZ3RoXSA9PT0ga2V5KVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcnRpYWxNYXRjaCA9IHNlcXVlbmNlcy5sZW5ndGggPiAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlcXVlbmNlLmZ1bGxNYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXF1ZW5jZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uc2VxdWVuY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VxdWVuY2U6IHNlcXVlbmNlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0aWFsTWF0Y2gsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxNYXRjaDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbE1hdGNoICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXNGdWxsTWF0Y2goeyBjb21tYW5kOiBzZXF1ZW5jZSwgZXZlbnRzOiBhY2MuZXZlbnRzIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKHNlcXVlbmNlcyA9PiBzZXF1ZW5jZXMucGFydGlhbE1hdGNoIHx8IHNlcXVlbmNlcy5mdWxsTWF0Y2gpO1xuXG4gICAgICAgICAgICAgICAgbGV0IFttYXRjaF0gPSByZXN1bHQ7XG4gICAgICAgICAgICAgICAgaWYgKCFtYXRjaCB8fCB0aGlzLm1vZGlmaWVyc09uKGV2ZW50KSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBldmVudHM6IFtdLCBzZXF1ZW5jZXM6IHRoaXMuX3NlcXVlbmNlcyB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgICAqIGhhbmRsZSBjYXNlIG9mIFwiP1wiIHNlcXVlbmNlIGFuZCBcIj8gYVwiIHNlcXVlbmNlXG4gICAgICAgICAgICAgICAgICogbmVlZCB0byBkZXRlcm1pbmUgd2hpY2ggb25lIHRvIHRyaWdnZXIuXG4gICAgICAgICAgICAgICAgICogaWYgYm90aCBtYXRjaCwgd2UgcGljayB0aGUgbG9uZ2VyIG9uZSAoPyBhKSBpbiB0aGlzIGNhc2UuXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgY29uc3QgZ3Vlc3MgPSBtYXhBcnJheVByb3AoJ3ByaW9yaXR5JywgcmVzdWx0KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDEgJiYgZ3Vlc3MuZnVsbE1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7IGV2ZW50czogW10sIGNvbW1hbmQ6IGd1ZXNzLCBzZXF1ZW5jZXM6IHRoaXMuX3NlcXVlbmNlcyB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgZXZlbnRzOiBbLi4uYWNjLmV2ZW50cywgZXZlbnRdLCBjb21tYW5kOiByZXN1bHQsIHNlcXVlbmNlczogcmVzdWx0IH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChtYXRjaC5mdWxsTWF0Y2gpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgZXZlbnRzOiBbXSwgY29tbWFuZDogbWF0Y2gsIHNlcXVlbmNlczogdGhpcy5fc2VxdWVuY2VzIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB7IGV2ZW50czogWy4uLmFjYy5ldmVudHMsIGV2ZW50XSwgY29tbWFuZDogcmVzdWx0LCBzZXF1ZW5jZXM6IHJlc3VsdCB9O1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHsgZXZlbnRzOiBbXSwgc2VxdWVuY2VzOiBbXSB9XG4gICAgICAgICksXG4gICAgICAgIHN3aXRjaE1hcCgoeyBjb21tYW5kIH0pID0+IHtcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbW1hbmQpKSB7XG4gICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICAgKiBBZGQgYSB0aW1lciB0byBoYW5kbGUgdGhlIGNhc2Ugd2hlcmUgZm9yIGV4YW1wbGU6XG4gICAgICAgICAgICAgICAgICogYSBzZXF1ZW5jZSBcIj9cIiBpcyByZWdpc3RlcmVkIGFuZCBcIj8gYVwiIGlzIHJlZ2lzdGVyZWQgYXMgd2VsbFxuICAgICAgICAgICAgICAgICAqIGlmIHRoZSB1c2VyIGRvZXMgbm90IGhpdCBhbnkga2V5IGZvciA1MDBtcywgdGhlIHNpbmdsZSBzZXF1ZW5jZSB3aWxsIHRyaWdnZXJcbiAgICAgICAgICAgICAgICAgKiBpZiBhbnkga2V5ZG93biBldmVudCBvY2N1ciwgdGhpcyB0aW1lciB3aWxsIHJlc2V0LCBnaXZlbiBhIGNoYW5jZSB0byBjb21wbGV0ZVxuICAgICAgICAgICAgICAgICAqIHRoZSBmdWxsIHNlcXVlbmNlICg/IGEpIGluIHRoaXMgY2FzZS5cbiAgICAgICAgICAgICAgICAgKiBUaGlzIGRlbGF5IG9ubHkgb2NjdXJzIHdoZW4gc2luZ2xlIGtleSBzZXF1ZW5jZSBpcyB0aGUgYmVnaW5uaW5nIG9mIGFub3RoZXIgc2VxdWVuY2UuXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRpbWVyKDUwMCkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgbWFwKCgpID0+ICh7IGNvbW1hbmQ6IGNvbW1hbmQuZmlsdGVyKGNvbW1hbmQgPT4gY29tbWFuZC5mdWxsTWF0Y2gpWzBdIH0pKSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG9mKHsgY29tbWFuZCB9KTtcbiAgICAgICAgfSksXG4gICAgICAgIGZpbHRlcigoeyBjb21tYW5kIH0pID0+IGNvbW1hbmQgJiYgY29tbWFuZC5mdWxsTWF0Y2gpLFxuICAgICAgICBtYXAoKHsgY29tbWFuZCB9KSA9PiBjb21tYW5kKSxcbiAgICAgICAgZmlsdGVyKChzaG9ydGN1dDogUGFyc2VkU2hvcnRjdXQpID0+IGlzRnVuY3Rpb24oc2hvcnRjdXQuY29tbWFuZCkpLFxuICAgICAgICBmaWx0ZXIodGhpcy5pc0FsbG93ZWQpLFxuICAgICAgICB0YXAoc2hvcnRjdXQgPT4gIXNob3J0Y3V0LnByZXZlbnREZWZhdWx0IHx8IHNob3J0Y3V0LmV2ZW50LnByZXZlbnREZWZhdWx0KCkpLFxuICAgICAgICB0aHJvdHRsZShzaG9ydGN1dCA9PiB0aW1lcihzaG9ydGN1dC50aHJvdHRsZVRpbWUpKSxcbiAgICAgICAgdGFwKHNob3J0Y3V0ID0+IHNob3J0Y3V0LmNvbW1hbmQoeyBldmVudDogc2hvcnRjdXQuZXZlbnQsIGtleTogc2hvcnRjdXQua2V5IH0pKSxcbiAgICAgICAgdGFwKHNob3J0Y3V0ID0+IHRoaXMuX3ByZXNzZWQubmV4dCh7IGV2ZW50OiBzaG9ydGN1dC5ldmVudCwga2V5OiBzaG9ydGN1dC5rZXkgfSkpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5yZXNldENvdW50ZXIkKSxcbiAgICAgICAgcmVwZWF0KClcbiAgICApO1xuXG4gICAgLyoqXG4gICAgICogQGlnbm9yZVxuICAgICAqIEBwYXJhbSBjb21tYW5kXG4gICAgICogQHBhcmFtIGV2ZW50c1xuICAgICAqL1xuICAgIHByaXZhdGUgaXNGdWxsTWF0Y2goeyBjb21tYW5kLCBldmVudHMgfSkge1xuICAgICAgICBpZiAoIWNvbW1hbmQpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29tbWFuZC5zZXF1ZW5jZS5zb21lKHNlcXVlbmNlID0+IHtcbiAgICAgICAgICAgIHJldHVybiBzZXF1ZW5jZS5sZW5ndGggPT09IGV2ZW50cy5sZW5ndGggKyAxO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXQgc2hvcnRjdXRzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2hvcnRjdXRzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2godGhpcy5rZXlkb3duU2VxdWVuY2UkLnN1YnNjcmliZSgpLCB0aGlzLmtleWRvd25Db21ibyQuc3Vic2NyaWJlKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKiBAcGFyYW0gZXZlbnRcbiAgICAgKi9cbiAgICBwcml2YXRlIF9jaGFyYWN0ZXJGcm9tRXZlbnQoZXZlbnQpOiBbc3RyaW5nLCBib29sZWFuXSB7XG4gICAgICAgIGlmICh0eXBlb2YgZXZlbnQud2hpY2ggIT09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgICAgIGV2ZW50LndoaWNoID0gZXZlbnQua2V5Q29kZTtcbiAgICAgICAgfVxuICAgICAgICAvLyBmb3Igbm9uIGtleXByZXNzIGV2ZW50cyB0aGUgc3BlY2lhbCBtYXBzIGFyZSBuZWVkZWRcbiAgICAgICAgaWYgKF9NQVBbZXZlbnQud2hpY2hdKSB7XG4gICAgICAgICAgICByZXR1cm4gW19NQVBbZXZlbnQud2hpY2hdLCBldmVudC5zaGlmdEtleV07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoX0tFWUNPREVfTUFQW2V2ZW50LndoaWNoXSkge1xuICAgICAgICAgICAgcmV0dXJuIFtfS0VZQ09ERV9NQVBbZXZlbnQud2hpY2hdLCBldmVudC5zaGlmdEtleV07XG4gICAgICAgIH1cbiAgICAgICAgLy8gaWYgaXQgaXMgbm90IGluIHRoZSBzcGVjaWFsIG1hcFxuXG4gICAgICAgIC8vIHdpdGgga2V5ZG93biBhbmQga2V5dXAgZXZlbnRzIHRoZSBjaGFyYWN0ZXIgc2VlbXMgdG8gYWx3YXlzXG4gICAgICAgIC8vIGNvbWUgaW4gYXMgYW4gdXBwZXJjYXNlIGNoYXJhY3RlciB3aGV0aGVyIHlvdSBhcmUgcHJlc3Npbmcgc2hpZnRcbiAgICAgICAgLy8gb3Igbm90LiAgd2Ugc2hvdWxkIG1ha2Ugc3VyZSBpdCBpcyBhbHdheXMgbG93ZXJjYXNlIGZvciBjb21wYXJpc29uc1xuICAgICAgICByZXR1cm4gW1N0cmluZy5mcm9tQ2hhckNvZGUoZXZlbnQud2hpY2gpLnRvTG93ZXJDYXNlKCksIGV2ZW50LnNoaWZ0S2V5XTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNoYXJhY3RlckZyb21FdmVudChldmVudCkge1xuICAgICAgICBsZXQgW2tleSwgc2hpZnRLZXldID0gdGhpcy5fY2hhcmFjdGVyRnJvbUV2ZW50KGV2ZW50KTtcbiAgICAgICAgaWYgKHNoaWZ0S2V5ICYmIF9TSElGVF9NQVBba2V5XSkge1xuICAgICAgICAgICAgcmV0dXJuIFtfU0hJRlRfTUFQW2tleV0sIHNoaWZ0S2V5XTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW2tleSwgc2hpZnRLZXldO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKiBSZW1vdmUgc3Vic2NyaXB0aW9uLlxuICAgICAqL1xuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZm9yRWFjaChzdWIgPT4gc3ViLnVuc3Vic2NyaWJlKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKiBAcGFyYW0gc2hvcnRjdXRzXG4gICAgICovXG4gICAgcHJpdmF0ZSBpc1NlcXVlbmNlKHNob3J0Y3V0czogc3RyaW5nW10pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICFzaG9ydGN1dHMuc29tZShzaG9ydGN1dCA9PiBzaG9ydGN1dC5pbmNsdWRlcyhcIitcIikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBuZXcgc2hvcnRjdXQvc1xuICAgICAqL1xuICAgIHB1YmxpYyBhZGQoc2hvcnRjdXRzOiBTaG9ydGN1dElucHV0W10gfCBTaG9ydGN1dElucHV0KTogc3RyaW5nW10ge1xuICAgICAgICBzaG9ydGN1dHMgPSBBcnJheS5pc0FycmF5KHNob3J0Y3V0cykgPyBzaG9ydGN1dHMgOiBbc2hvcnRjdXRzXTtcbiAgICAgICAgY29uc3QgY29tbWFuZHMgPSB0aGlzLnBhcnNlQ29tbWFuZChzaG9ydGN1dHMpO1xuICAgICAgICBjb21tYW5kcy5mb3JFYWNoKGNvbW1hbmQgPT4ge1xuICAgICAgICAgICAgaWYgKGNvbW1hbmQuaXNTZXF1ZW5jZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3NlcXVlbmNlcy5wdXNoKGNvbW1hbmQpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX3Nob3J0Y3V0cy5wdXNoKGNvbW1hbmQpO1xuICAgICAgICB9KTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9zaG9ydGN1dHNTdWIubmV4dChbLi4udGhpcy5fc2hvcnRjdXRzLCAuLi50aGlzLl9zZXF1ZW5jZXNdKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBjb21tYW5kcy5tYXAoY29tbWFuZCA9PiBjb21tYW5kLmlkKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYSBjb21tYW5kIGJhc2VkIG9uIGtleSBvciBhcnJheSBvZiBrZXlzLlxuICAgICAqIGNhbiBiZSB1c2VkIGZvciBjbGVhbnVwLlxuICAgICAqIEByZXR1cm5zXG4gICAgICogQHBhcmFtIGlkc1xuICAgICAqL1xuICAgIHB1YmxpYyByZW1vdmUoaWRzOiBzdHJpbmcgfCBzdHJpbmdbXSk6IEtleWJvYXJkU2hvcnRjdXRzU2VydmljZSB7XG4gICAgICAgIGlkcyA9IEFycmF5LmlzQXJyYXkoaWRzKSA/IGlkcyA6IFtpZHNdO1xuICAgICAgICB0aGlzLl9zaG9ydGN1dHMgPSB0aGlzLl9zaG9ydGN1dHMuZmlsdGVyKHNob3J0Y3V0ID0+ICFpZHMuaW5jbHVkZXMoc2hvcnRjdXQuaWQpKTtcbiAgICAgICAgdGhpcy5fc2VxdWVuY2VzID0gdGhpcy5fc2VxdWVuY2VzLmZpbHRlcihzaG9ydGN1dCA9PiAhaWRzLmluY2x1ZGVzKHNob3J0Y3V0LmlkKSk7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fc2hvcnRjdXRzU3ViLm5leHQoWy4uLnRoaXMuX3Nob3J0Y3V0cywgLi4udGhpcy5fc2VxdWVuY2VzXSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGFuIG9ic2VydmFibGUgb2Yga2V5Ym9hcmQgc2hvcnRjdXQgZmlsdGVyZWQgYnkgYSBzcGVjaWZpYyBrZXkuXG4gICAgICogQHBhcmFtIGtleSAtIHRoZSBrZXkgdG8gZmlsdGVyIHRoZSBvYnNlcnZhYmxlIGJ5LlxuICAgICAqL1xuICAgIHB1YmxpYyBzZWxlY3Qoa2V5OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFNob3J0Y3V0RXZlbnRPdXRwdXQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJlc3NlZCQucGlwZShcbiAgICAgICAgICAgIGZpbHRlcigoeyBldmVudCwga2V5OiBldmVudEtleXMgfSkgPT4ge1xuICAgICAgICAgICAgICAgIGV2ZW50S2V5cyA9IEFycmF5LmlzQXJyYXkoZXZlbnRLZXlzKSA/IGV2ZW50S2V5cyA6IFtldmVudEtleXNdO1xuICAgICAgICAgICAgICAgIHJldHVybiAhIWV2ZW50S2V5cy5maW5kKGV2ZW50S2V5ID0+IGV2ZW50S2V5ID09PSBrZXkpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICogdHJhbnNmb3JtcyBhIHNob3J0Y3V0IHRvOlxuICAgICAqIGEgcHJlZGljYXRlIGZ1bmN0aW9uXG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXRLZXlzID0gKGtleXM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICAgIHJldHVybiBrZXlzXG4gICAgICAgICAgICAubWFwKGtleSA9PiBrZXkudHJpbSgpLnRvTG93ZXJDYXNlKCkpXG4gICAgICAgICAgICAuZmlsdGVyKGtleSA9PiBrZXkgIT09IFwiK1wiKVxuICAgICAgICAgICAgLm1hcChrZXkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIGZvciBtb2RpZmllcnMgbGlrZSBjb250cm9sIGtleVxuICAgICAgICAgICAgICAgIC8vIGxvb2sgZm9yIGV2ZW50WydjdHJsS2V5J11cbiAgICAgICAgICAgICAgICAvLyBvdGhlcndpc2UgdXNlIHRoZSBrZXlDb2RlXG4gICAgICAgICAgICAgICAgaWYgKG1vZGlmaWVycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudCA9PiAhIWV2ZW50W21vZGlmaWVyc1trZXldXTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgW2NoYXJhY3RlcnMsIHNoaWZ0S2V5XSA9IHRoaXMuY2hhcmFjdGVyRnJvbUV2ZW50KGV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgY2hhcmFjdGVycyA9IEFycmF5LmlzQXJyYXkoY2hhcmFjdGVycykgPyBjaGFyYWN0ZXJzIDogW2NoYXJhY3RlcnNdO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hhcmFjdGVycy5zb21lKGNoYXIgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoYXIgPT09IGtleSAmJiBzaGlmdEtleSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtleSA9PT0gY2hhcjtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKiBAcGFyYW0gZXZlbnRcbiAgICAgKi9cbiAgICBwcml2YXRlIG1vZGlmaWVyc09uKGV2ZW50KSB7XG4gICAgICAgIHJldHVybiBbXCJtZXRhS2V5XCIsIFwiYWx0S2V5XCIsIFwiY3RybEtleVwiXS5zb21lKG1vZCA9PiBldmVudFttb2RdKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICogUGFyc2UgZWFjaCBjb21tYW5kIHVzaW5nIGdldEtleXMgZnVuY3Rpb25cbiAgICAgKi9cbiAgICBwcml2YXRlIHBhcnNlQ29tbWFuZChjb21tYW5kOiBTaG9ydGN1dElucHV0IHwgU2hvcnRjdXRJbnB1dFtdKTogUGFyc2VkU2hvcnRjdXRbXSB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmRzID0gQXJyYXkuaXNBcnJheShjb21tYW5kKSA/IGNvbW1hbmQgOiBbY29tbWFuZF07XG4gICAgICAgIHJldHVybiBjb21tYW5kcy5tYXAoY29tbWFuZCA9PiB7XG4gICAgICAgICAgICBjb25zdCBrZXlzID0gQXJyYXkuaXNBcnJheShjb21tYW5kLmtleSkgPyBjb21tYW5kLmtleSA6IFtjb21tYW5kLmtleV07XG4gICAgICAgICAgICBjb25zdCBwcmlvcml0eSA9IE1hdGgubWF4KC4uLmtleXMubWFwKGtleSA9PiBrZXkuc3BsaXQoXCIgXCIpLmZpbHRlcihpZGVudGl0eSkubGVuZ3RoKSk7XG4gICAgICAgICAgICBjb25zdCBwcmVkaWNhdGVzID0ga2V5cy5tYXAoa2V5ID0+IHRoaXMuZ2V0S2V5cyhrZXkuc3BsaXQoXCIgXCIpLmZpbHRlcihpZGVudGl0eSkpKTtcbiAgICAgICAgICAgIGNvbnN0IGlzU2VxdWVuY2UgPSB0aGlzLmlzU2VxdWVuY2Uoa2V5cyk7XG4gICAgICAgICAgICBjb25zdCBzZXF1ZW5jZSA9IGlzU2VxdWVuY2VcbiAgICAgICAgICAgICAgICA/IGtleXMubWFwKGtleSA9PlxuICAgICAgICAgICAgICAgICAgICAgIGtleVxuICAgICAgICAgICAgICAgICAgICAgICAgICAuc3BsaXQoXCIgXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoaWRlbnRpdHkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoa2V5ID0+IGtleS50cmltKCkpXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgOiBbXTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgLi4uY29tbWFuZCxcbiAgICAgICAgICAgICAgICBpc1NlcXVlbmNlLFxuICAgICAgICAgICAgICAgIHNlcXVlbmNlOiBpc1NlcXVlbmNlID8gc2VxdWVuY2UgOiBbXSxcbiAgICAgICAgICAgICAgICBhbGxvd0luOiBjb21tYW5kLmFsbG93SW4gfHwgW10sXG4gICAgICAgICAgICAgICAga2V5OiBrZXlzLFxuICAgICAgICAgICAgICAgIGlkOiBgJHtndWlkKyt9YCxcbiAgICAgICAgICAgICAgICB0aHJvdHRsZTogaXNOaWxsKGNvbW1hbmQudGhyb3R0bGVUaW1lKSA/IHRoaXMudGhyb3R0bGVUaW1lIDogY29tbWFuZC50aHJvdHRsZVRpbWUsXG4gICAgICAgICAgICAgICAgcHJpb3JpdHk6IHByaW9yaXR5LFxuICAgICAgICAgICAgICAgIHByZWRpY2F0ZXM6IHByZWRpY2F0ZXNcbiAgICAgICAgICAgIH0gYXMgUGFyc2VkU2hvcnRjdXQ7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==