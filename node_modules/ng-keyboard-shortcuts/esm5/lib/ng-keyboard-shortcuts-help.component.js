import * as tslib_1 from "tslib";
import { ApplicationRef, Component, ComponentFactoryResolver, ElementRef, Injector, Input, TemplateRef, ViewChild, ViewContainerRef } from "@angular/core";
import { DomPortalOutlet } from "./dom-portal-outlet";
import { TemplatePortal } from "./portal";
import { KeyboardShortcutsService } from "./ng-keyboard-shortcuts.service";
import { KeyboardShortcutsHelpService } from "./ng-keyboard-shortcuts-help.service";
import { animate, style, transition, trigger } from "@angular/animations";
import { distinctUntilChanged } from "rxjs/operators";
import { groupBy } from "./utils";
import { map } from "rxjs/internal/operators";
/**
 * @ignore
 */
var scrollAbleKeys = new Map([[31, 1], [38, 1], [39, 1], [40, 1]]);
/**
 * @ignore
 */
var preventDefault = function (ignore) { return function (e) {
    var modal = e.target.closest(ignore);
    if (modal) {
        return;
    }
    e = e || window.event;
    if (e.preventDefault)
        e.preventDefault();
    e.returnValue = false;
}; };
var ɵ0 = preventDefault;
/**
 * @ignore
 */
var preventDefaultForScrollKeys = function (e) {
    if (!scrollAbleKeys.has(e.keyCode)) {
        return;
    }
    preventDefault(e);
    return false;
};
var ɵ1 = preventDefaultForScrollKeys;
/**
 * @ignore
 */
var scrollEvents = [{ name: 'wheel', callback: null }, { name: 'touchmove', callback: null }, { name: 'DOMMouseScroll', callback: null }];
/**
 * @ignore
 */
var disableScroll = function (ignore) {
    scrollEvents = scrollEvents.map(function (event) {
        var callback = preventDefault(ignore);
        window.addEventListener(event.name, callback, { passive: false });
        return tslib_1.__assign({}, event, { callback: callback });
    });
    window.addEventListener('keydown', preventDefaultForScrollKeys);
};
var ɵ2 = disableScroll;
/**
 * @ignore
 */
var enableScroll = function () {
    scrollEvents = scrollEvents.map(function (event) {
        window.removeEventListener(event.name, event.callback);
        return tslib_1.__assign({}, event, { callback: null });
    });
    window.removeEventListener('keydown', preventDefaultForScrollKeys);
};
var ɵ3 = enableScroll;
/**
 * A Component to show all registered shortcut in the app
 * it is shown as a modal
 */
var KeyboardShortcutsHelpComponent = /** @class */ (function () {
    /**
     * @ignore
     */
    function KeyboardShortcutsHelpComponent(componentFactoryResolver, appRef, keyboard, element, keyboardHelp, viewContainer, injector) {
        this.componentFactoryResolver = componentFactoryResolver;
        this.appRef = appRef;
        this.keyboard = keyboard;
        this.element = element;
        this.keyboardHelp = keyboardHelp;
        this.viewContainer = viewContainer;
        this.injector = injector;
        /**
         * Disable scrolling while modal is open
         */
        this.disableScrolling = true;
        this.className = 'help-modal';
        /**
         * The title of the help screen
         * @default: "Keyboard shortcuts"
         */
        this.title = "Keyboard shortcuts";
        /**
         * What message to show when no shortcuts are available on the page.
         * @default "No shortcuts available"
         */
        this.emptyMessage = "No shortcuts available";
        /**
         * @ignore
         */
        this.showing = false;
        this.bodyPortalHost = new DomPortalOutlet(document.body, this.componentFactoryResolver, this.appRef, this.injector);
    }
    Object.defineProperty(KeyboardShortcutsHelpComponent.prototype, "key", {
        /**
         * The shortcut to show/hide the help screen
         */
        set: function (value) {
            var _this = this;
            this._key = value;
            if (!value) {
                return;
            }
            if (this.clearIds) {
                this.keyboard.remove(this.clearIds);
            }
            this.clearIds = this.keyboard.add({
                key: value,
                preventDefault: true,
                command: function () { return _this.toggle(); }
            });
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(KeyboardShortcutsHelpComponent.prototype, "closeKey", {
        set: function (value) {
            var _this = this;
            this._closeKey = value;
            if (!value) {
                return;
            }
            if (this.closeKeyIds) {
                this.keyboard.remove(this.closeKeyIds);
            }
            this.closeKeyIds = this.keyboard.add({
                key: value,
                preventDefault: true,
                command: function () { return _this.hide(); }
            });
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Reveal the help screen manually.
     */
    KeyboardShortcutsHelpComponent.prototype.reveal = function () {
        this.hide();
        if (this.disableScrolling) {
            disableScroll("." + this.className);
        }
        var portal = new TemplatePortal(this.template, this.viewContainer);
        this.bodyPortalHost.attach(portal);
        this.showing = true;
        return this;
    };
    /**
     * Check if help screen is visible.
     * @returns boolean
     */
    KeyboardShortcutsHelpComponent.prototype.visible = function () {
        return this.bodyPortalHost.hasAttached();
    };
    /**
     * Hide the help screen manually.
     */
    KeyboardShortcutsHelpComponent.prototype.hide = function () {
        if (this.disableScrolling) {
            enableScroll();
        }
        if (!this.bodyPortalHost.hasAttached()) {
            return this;
        }
        this.bodyPortalHost.detach();
        this.showing = false;
        return this;
    };
    /**
     * @ignore
     */
    KeyboardShortcutsHelpComponent.prototype.ngOnDestroy = function () {
        this.hide();
        if (this.clearIds) {
            this.keyboard.remove(this.clearIds);
        }
        if (this.closeKeyIds) {
            this.keyboard.remove(this.closeKeyIds);
        }
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
        if (this.timeoutId) {
            clearTimeout(this.timeoutId);
        }
    };
    /**
     * Show/Hide the help screen manually.
     */
    KeyboardShortcutsHelpComponent.prototype.toggle = function () {
        this.visible() ? this.hide() : this.reveal();
        return this;
    };
    /**
     * @ignore
     */
    KeyboardShortcutsHelpComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.subscription = this.keyboardHelp.shortcuts$
            .pipe(distinctUntilChanged(), map(function (shortcuts) { return groupBy(shortcuts, "label"); }))
            .subscribe(function (shortcuts) {
            _this.shortcuts = shortcuts;
            _this.labels = Object.keys(shortcuts);
        });
    };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], KeyboardShortcutsHelpComponent.prototype, "disableScrolling", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String),
        tslib_1.__metadata("design:paramtypes", [String])
    ], KeyboardShortcutsHelpComponent.prototype, "key", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String),
        tslib_1.__metadata("design:paramtypes", [String])
    ], KeyboardShortcutsHelpComponent.prototype, "closeKey", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], KeyboardShortcutsHelpComponent.prototype, "title", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], KeyboardShortcutsHelpComponent.prototype, "emptyMessage", void 0);
    tslib_1.__decorate([
        ViewChild(TemplateRef, { static: false }),
        tslib_1.__metadata("design:type", TemplateRef)
    ], KeyboardShortcutsHelpComponent.prototype, "template", void 0);
    KeyboardShortcutsHelpComponent = tslib_1.__decorate([
        Component({
            selector: "ng-keyboard-shortcuts-help",
            template: "<ng-template>\n    <div class=\"help-modal__container\">\n        <div class=\"{{className}}\" [@enterAnimation] *ngIf=\"showing\">\n            <div class=\"title\">\n                <h3 class=\"title__text\">{{title}}</h3>\n            </div>\n            <div class=\"help-modal__body\">\n                <span *ngIf=\"!labels.length\">\n                    {{emptyMessage}}\n                </span>\n                <div>\n                    <ul *ngFor=\"let label of labels\" class=\"help-modal__list\">\n                        <h4 class=\"item-group-label\">{{label}}</h4>\n                        <ng-keyboard-shortcuts-help-item\n                                *ngFor=\"let shortcut of shortcuts[label]; let i = index\"\n                                [shortcut]=\"shortcut\"\n                                [index]=\"i\"\n                        ></ng-keyboard-shortcuts-help-item>\n                    </ul>\n                </div>\n            </div>\n        </div>\n        <div class=\"help-modal__backdrop\" [@overlayAnimation] (click)=\"hide()\" *ngIf=\"showing\"></div>\n    </div>\n</ng-template>\n",
            animations: [
                trigger("enterAnimation", [
                    transition(":enter", [
                        style({ transform: "translateX(-100%)", opacity: 0 }),
                        animate("0.33s cubic-bezier(0,0,0.3,1)", style({ transform: "translateX(0)", opacity: 1 }))
                    ]),
                    transition(":leave", [
                        style({ transform: "translateX(0)", opacity: 1 }),
                        animate("0.23s cubic-bezier(0,0,0.3,1)", style({ transform: "translateX(-100%)", opacity: 0 }))
                    ])
                ]),
                trigger("overlayAnimation", [
                    transition(":enter", [
                        style({ opacity: 0 }),
                        animate("1s cubic-bezier(0,0,0.3,1)", style({ opacity: 1 }))
                    ]),
                    transition(":leave", [
                        style({ opacity: 1 }),
                        animate("1s cubic-bezier(0,0,0.3,1)", style({ opacity: 0 }))
                    ])
                ])
            ],
            styles: [".help-modal__container{position:fixed;top:0;right:0;z-index:10000;left:0;bottom:0;display:flex;align-items:center;justify-content:center}.help-modal{z-index:1000;min-width:420px;max-height:calc(100% - 100px);overflow:auto;padding:20px;box-shadow:0 11px 15px -7px rgba(0,0,0,.2),0 24px 38px 3px rgba(0,0,0,.14),0 9px 46px 8px rgba(0,0,0,.12);background:#fff}.item-group-label{text-transform:capitalize}.title{padding:20px 0}.title__text{margin:0;padding:0}.help-modal__list{padding:0}.help-modal__backdrop{position:absolute;background:rgba(0,0,0,.27);top:0;bottom:0;left:0;right:0;z-index:500;pointer-events:auto;-webkit-tap-highlight-color:transparent;opacity:1}"]
        }),
        tslib_1.__metadata("design:paramtypes", [ComponentFactoryResolver,
            ApplicationRef,
            KeyboardShortcutsService,
            ElementRef,
            KeyboardShortcutsHelpService,
            ViewContainerRef,
            Injector])
    ], KeyboardShortcutsHelpComponent);
    return KeyboardShortcutsHelpComponent;
}());
export { KeyboardShortcutsHelpComponent };
export { ɵ0, ɵ1, ɵ2, ɵ3 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmcta2V5Ym9hcmQtc2hvcnRjdXRzLWhlbHAuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmcta2V5Ym9hcmQtc2hvcnRjdXRzLyIsInNvdXJjZXMiOlsibGliL25nLWtleWJvYXJkLXNob3J0Y3V0cy1oZWxwLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNILGNBQWMsRUFDZCxTQUFTLEVBQ1Qsd0JBQXdCLEVBQUUsVUFBVSxFQUNwQyxRQUFRLEVBQ1IsS0FBSyxFQUdMLFdBQVcsRUFDWCxTQUFTLEVBQ1QsZ0JBQWdCLEVBQ25CLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQzFDLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQzNFLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMxRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2xDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUc5Qzs7R0FFRztBQUNILElBQU0sY0FBYyxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3BFOztHQUVHO0FBQ0gsSUFBTSxjQUFjLEdB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LEVBQUUsQ0FBQyxFQUFFLENBQUM7d0JBQ3JCLE9BQU8sQ0FBQyw0QkFBNEIsRUFBRSxLQUFLLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztxQkFDL0QsQ0FBQztpQkFDTCxDQUFDO2FBQ0w7O1NBQ0osQ0FBQztpREFrRndDLHdCQUF3QjtZQUMxQyxjQUFjO1lBQ1osd0JBQXdCO1lBQ3pCLFVBQVU7WUFDTCw0QkFBNEI7WUFDM0IsZ0JBQWdCO1lBQ3JCLFFBQVE7T0F2RnJCLDhCQUE4QixDQTZMMUM7SUFBRCxxQ0FBQztDQUFBLEFBN0xELElBNkxDO1NBN0xZLDhCQUE4QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQXBwbGljYXRpb25SZWYsXG4gICAgQ29tcG9uZW50LFxuICAgIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgRWxlbWVudFJlZiwgSG9zdEJpbmRpbmcsXG4gICAgSW5qZWN0b3IsXG4gICAgSW5wdXQsXG4gICAgT25EZXN0cm95LFxuICAgIE9uSW5pdCxcbiAgICBUZW1wbGF0ZVJlZixcbiAgICBWaWV3Q2hpbGQsXG4gICAgVmlld0NvbnRhaW5lclJlZlxufSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgRG9tUG9ydGFsT3V0bGV0IH0gZnJvbSBcIi4vZG9tLXBvcnRhbC1vdXRsZXRcIjtcbmltcG9ydCB7IFRlbXBsYXRlUG9ydGFsIH0gZnJvbSBcIi4vcG9ydGFsXCI7XG5pbXBvcnQgeyBLZXlib2FyZFNob3J0Y3V0c1NlcnZpY2UgfSBmcm9tIFwiLi9uZy1rZXlib2FyZC1zaG9ydGN1dHMuc2VydmljZVwiO1xuaW1wb3J0IHsgS2V5Ym9hcmRTaG9ydGN1dHNIZWxwU2VydmljZSB9IGZyb20gXCIuL25nLWtleWJvYXJkLXNob3J0Y3V0cy1oZWxwLnNlcnZpY2VcIjtcbmltcG9ydCB7IGFuaW1hdGUsIHN0eWxlLCB0cmFuc2l0aW9uLCB0cmlnZ2VyIH0gZnJvbSBcIkBhbmd1bGFyL2FuaW1hdGlvbnNcIjtcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XG5pbXBvcnQgeyBncm91cEJ5IH0gZnJvbSBcIi4vdXRpbHNcIjtcbmltcG9ydCB7IG1hcCB9IGZyb20gXCJyeGpzL2ludGVybmFsL29wZXJhdG9yc1wiO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uTGlrZSB9IGZyb20gXCJyeGpzXCI7XG5cbi8qKlxuICogQGlnbm9yZVxuICovXG5jb25zdCBzY3JvbGxBYmxlS2V5cyA9IG5ldyBNYXAoW1szMSwgMV0sIFszOCwxXSwgWzM5LCAxXSwgWzQwLCAxXV0pO1xuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmNvbnN0IHByZXZlbnREZWZhdWx0ID0gKGlnbm9yZTogc3RyaW5nKSA9PiBlID0+IHtcbiAgICBjb25zdCBtb2RhbCA9IGUudGFyZ2V0LmNsb3Nlc3QoaWdub3JlKTtcbiAgICBpZiAobW9kYWwpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBlID0gZSB8fCB3aW5kb3cuZXZlbnQ7XG4gICAgaWYgKGUucHJldmVudERlZmF1bHQpIGUucHJldmVudERlZmF1bHQoKTtcbiAgICBlLnJldHVyblZhbHVlID0gZmFsc2U7XG59O1xuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmNvbnN0IHByZXZlbnREZWZhdWx0Rm9yU2Nyb2xsS2V5cyA9IGUgPT4ge1xuICAgIGlmICghc2Nyb2xsQWJsZUtleXMuaGFzKGUua2V5Q29kZSkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBwcmV2ZW50RGVmYXVsdChlKTtcbiAgICByZXR1cm4gZmFsc2U7XG59O1xuLyoqXG4gKiBAaWdub3JlXG4gKi9cbmxldCBzY3JvbGxFdmVudHMgPSBbe25hbWU6ICd3aGVlbCcsIGNhbGxiYWNrOiBudWxsfSwge25hbWU6ICd0b3VjaG1vdmUnLCBjYWxsYmFjazogbnVsbH0sIHtuYW1lOiAnRE9NTW91c2VTY3JvbGwnLCBjYWxsYmFjazogbnVsbH0gXTtcblxuXG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuY29uc3QgZGlzYWJsZVNjcm9sbCA9IChpZ25vcmU6IHN0cmluZykgPT4ge1xuICAgIHNjcm9sbEV2ZW50cyA9IHNjcm9sbEV2ZW50cy5tYXAoZXZlbnQgPT4ge1xuICAgICAgICBjb25zdCBjYWxsYmFjayA9IHByZXZlbnREZWZhdWx0KGlnbm9yZSk7XG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKGV2ZW50Lm5hbWUsIGNhbGxiYWNrLCB7cGFzc2l2ZTogZmFsc2V9KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLmV2ZW50LFxuICAgICAgICAgICAgY2FsbGJhY2tcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgcHJldmVudERlZmF1bHRGb3JTY3JvbGxLZXlzKTtcbn07XG4vKipcbiAqIEBpZ25vcmVcbiAqL1xuY29uc3QgZW5hYmxlU2Nyb2xsID0gKCkgPT4ge1xuICAgIHNjcm9sbEV2ZW50cyA9IHNjcm9sbEV2ZW50cy5tYXAoZXZlbnQgPT4ge1xuICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudC5uYW1lLCBldmVudC5jYWxsYmFjayk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi5ldmVudCxcbiAgICAgICAgICAgIGNhbGxiYWNrOiBudWxsXG4gICAgICAgIH1cbiAgICB9KTtcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHByZXZlbnREZWZhdWx0Rm9yU2Nyb2xsS2V5cyk7XG59O1xuXG4vKipcbiAqIEEgQ29tcG9uZW50IHRvIHNob3cgYWxsIHJlZ2lzdGVyZWQgc2hvcnRjdXQgaW4gdGhlIGFwcFxuICogaXQgaXMgc2hvd24gYXMgYSBtb2RhbFxuICovXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogXCJuZy1rZXlib2FyZC1zaG9ydGN1dHMtaGVscFwiLFxuICAgIHRlbXBsYXRlVXJsOiBcIi4vbmcta2V5Ym9hcmQtc2hvcnRjdXRzLWhlbHAuY29tcG9uZW50Lmh0bWxcIixcbiAgICBzdHlsZVVybHM6IFtcIi4vbmcta2V5Ym9hcmQtc2hvcnRjdXRzLWhlbHAuY29tcG9uZW50LmNzc1wiXSxcbiAgICBhbmltYXRpb25zOiBbXG4gICAgICAgIHRyaWdnZXIoXCJlbnRlckFuaW1hdGlvblwiLCBbXG4gICAgICAgICAgICB0cmFuc2l0aW9uKFwiOmVudGVyXCIsIFtcbiAgICAgICAgICAgICAgICBzdHlsZSh7IHRyYW5zZm9ybTogXCJ0cmFuc2xhdGVYKC0xMDAlKVwiLCBvcGFjaXR5OiAwIH0pLFxuICAgICAgICAgICAgICAgIGFuaW1hdGUoXG4gICAgICAgICAgICAgICAgICAgIFwiMC4zM3MgY3ViaWMtYmV6aWVyKDAsMCwwLjMsMSlcIixcbiAgICAgICAgICAgICAgICAgICAgc3R5bGUoeyB0cmFuc2Zvcm06IFwidHJhbnNsYXRlWCgwKVwiLCBvcGFjaXR5OiAxIH0pXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgXSksXG4gICAgICAgICAgICB0cmFuc2l0aW9uKFwiOmxlYXZlXCIsIFtcbiAgICAgICAgICAgICAgICBzdHlsZSh7IHRyYW5zZm9ybTogXCJ0cmFuc2xhdGVYKDApXCIsIG9wYWNpdHk6IDEgfSksXG4gICAgICAgICAgICAgICAgYW5pbWF0ZShcbiAgICAgICAgICAgICAgICAgICAgXCIwLjIzcyBjdWJpYy1iZXppZXIoMCwwLDAuMywxKVwiLFxuICAgICAgICAgICAgICAgICAgICBzdHlsZSh7IHRyYW5zZm9ybTogXCJ0cmFuc2xhdGVYKC0xMDAlKVwiLCBvcGFjaXR5OiAwIH0pXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgXSlcbiAgICAgICAgXSksXG4gICAgICAgIHRyaWdnZXIoXCJvdmVybGF5QW5pbWF0aW9uXCIsIFtcbiAgICAgICAgICAgIHRyYW5zaXRpb24oXCI6ZW50ZXJcIiwgW1xuICAgICAgICAgICAgICAgIHN0eWxlKHsgb3BhY2l0eTogMCB9KSxcbiAgICAgICAgICAgICAgICBhbmltYXRlKFwiMXMgY3ViaWMtYmV6aWVyKDAsMCwwLjMsMSlcIiwgc3R5bGUoeyBvcGFjaXR5OiAxIH0pKVxuICAgICAgICAgICAgXSksXG4gICAgICAgICAgICB0cmFuc2l0aW9uKFwiOmxlYXZlXCIsIFtcbiAgICAgICAgICAgICAgICBzdHlsZSh7IG9wYWNpdHk6IDEgfSksXG4gICAgICAgICAgICAgICAgYW5pbWF0ZShcIjFzIGN1YmljLWJlemllcigwLDAsMC4zLDEpXCIsIHN0eWxlKHsgb3BhY2l0eTogMCB9KSlcbiAgICAgICAgICAgIF0pXG4gICAgICAgIF0pXG4gICAgXVxufSlcbmV4cG9ydCBjbGFzcyBLZXlib2FyZFNob3J0Y3V0c0hlbHBDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gICAgLyoqXG4gICAgICogRGlzYWJsZSBzY3JvbGxpbmcgd2hpbGUgbW9kYWwgaXMgb3BlblxuICAgICAqL1xuICAgIEBJbnB1dCgpIGRpc2FibGVTY3JvbGxpbmcgPSB0cnVlO1xuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICBwcml2YXRlIF9rZXk6IHN0cmluZztcblxuICAgIHB1YmxpYyBjbGFzc05hbWUgPSAnaGVscC1tb2RhbCc7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgc2hvcnRjdXQgdG8gc2hvdy9oaWRlIHRoZSBoZWxwIHNjcmVlblxuICAgICAqL1xuICAgIEBJbnB1dCgpXG4gICAgc2V0IGtleSh2YWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuX2tleSA9IHZhbHVlO1xuICAgICAgICBpZiAoIXZhbHVlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYodGhpcy5jbGVhcklkcykge1xuICAgICAgICAgICAgdGhpcy5rZXlib2FyZC5yZW1vdmUodGhpcy5jbGVhcklkcyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jbGVhcklkcyA9IHRoaXMua2V5Ym9hcmQuYWRkKHtcbiAgICAgICAgICAgIGtleTogdmFsdWUsXG4gICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogdHJ1ZSxcbiAgICAgICAgICAgIGNvbW1hbmQ6ICgpID0+IHRoaXMudG9nZ2xlKClcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHByaXZhdGUgX2Nsb3NlS2V5O1xuICAgIEBJbnB1dCgpXG4gICAgc2V0IGNsb3NlS2V5KHZhbHVlOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5fY2xvc2VLZXkgPSB2YWx1ZTtcbiAgICAgICAgaWYgKCF2YWx1ZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmNsb3NlS2V5SWRzKSB7XG4gICAgICAgICAgICB0aGlzLmtleWJvYXJkLnJlbW92ZSh0aGlzLmNsb3NlS2V5SWRzKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNsb3NlS2V5SWRzID0gdGhpcy5rZXlib2FyZC5hZGQoe1xuICAgICAgICAgICAga2V5OiB2YWx1ZSxcbiAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiB0cnVlLFxuICAgICAgICAgICAgY29tbWFuZDogKCkgPT4gdGhpcy5oaWRlKClcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhlIHRpdGxlIG9mIHRoZSBoZWxwIHNjcmVlblxuICAgICAqIEBkZWZhdWx0OiBcIktleWJvYXJkIHNob3J0Y3V0c1wiXG4gICAgICovXG4gICAgQElucHV0KCkgdGl0bGUgPSBcIktleWJvYXJkIHNob3J0Y3V0c1wiO1xuICAgIC8qKlxuICAgICAqIFdoYXQgbWVzc2FnZSB0byBzaG93IHdoZW4gbm8gc2hvcnRjdXRzIGFyZSBhdmFpbGFibGUgb24gdGhlIHBhZ2UuXG4gICAgICogQGRlZmF1bHQgXCJObyBzaG9ydGN1dHMgYXZhaWxhYmxlXCJcbiAgICAgKi9cbiAgICBASW5wdXQoKSBlbXB0eU1lc3NhZ2UgPSBcIk5vIHNob3J0Y3V0cyBhdmFpbGFibGVcIjtcbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgQFZpZXdDaGlsZChUZW1wbGF0ZVJlZiwgeyBzdGF0aWM6IGZhbHNlIH0pIHRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+O1xuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICBzaG9ydGN1dHM6IHsgbGFiZWw6IHN0cmluZzsga2V5OiBzdHJpbmcgfCBzdHJpbmdbXTsgZGVzY3JpcHRpb246IHN0cmluZyB9W107XG4gICAgLyoqXG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIHNob3dpbmcgPSBmYWxzZTtcbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgbGFiZWxzOiBzdHJpbmdbXTtcbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSBib2R5UG9ydGFsSG9zdDogRG9tUG9ydGFsT3V0bGV0O1xuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICAgICAgcHJpdmF0ZSBhcHBSZWY6IEFwcGxpY2F0aW9uUmVmLFxuICAgICAgICBwcml2YXRlIGtleWJvYXJkOiBLZXlib2FyZFNob3J0Y3V0c1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZWxlbWVudDogRWxlbWVudFJlZixcbiAgICAgICAgcHJpdmF0ZSBrZXlib2FyZEhlbHA6IEtleWJvYXJkU2hvcnRjdXRzSGVscFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgdmlld0NvbnRhaW5lcjogVmlld0NvbnRhaW5lclJlZixcbiAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3JcbiAgICApIHtcbiAgICAgICAgdGhpcy5ib2R5UG9ydGFsSG9zdCA9IG5ldyBEb21Qb3J0YWxPdXRsZXQoXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LFxuICAgICAgICAgICAgdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgICAgICAgICB0aGlzLmFwcFJlZixcbiAgICAgICAgICAgIHRoaXMuaW5qZWN0b3JcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXZlYWwgdGhlIGhlbHAgc2NyZWVuIG1hbnVhbGx5LlxuICAgICAqL1xuICAgIHJldmVhbCgpOiBLZXlib2FyZFNob3J0Y3V0c0hlbHBDb21wb25lbnQge1xuICAgICAgICB0aGlzLmhpZGUoKTtcbiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZVNjcm9sbGluZykge1xuICAgICAgICAgICAgZGlzYWJsZVNjcm9sbChgLiR7dGhpcy5jbGFzc05hbWV9YCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcG9ydGFsID0gbmV3IFRlbXBsYXRlUG9ydGFsKHRoaXMudGVtcGxhdGUsIHRoaXMudmlld0NvbnRhaW5lcik7XG4gICAgICAgIHRoaXMuYm9keVBvcnRhbEhvc3QuYXR0YWNoKHBvcnRhbCk7XG4gICAgICAgIHRoaXMuc2hvd2luZyA9IHRydWU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIGhlbHAgc2NyZWVuIGlzIHZpc2libGUuXG4gICAgICogQHJldHVybnMgYm9vbGVhblxuICAgICAqL1xuICAgIHZpc2libGUoKSA6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5ib2R5UG9ydGFsSG9zdC5oYXNBdHRhY2hlZCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhpZGUgdGhlIGhlbHAgc2NyZWVuIG1hbnVhbGx5LlxuICAgICAqL1xuICAgIGhpZGUoKSA6IEtleWJvYXJkU2hvcnRjdXRzSGVscENvbXBvbmVudCB7XG4gICAgICAgIGlmICh0aGlzLmRpc2FibGVTY3JvbGxpbmcpIHtcbiAgICAgICAgICAgIGVuYWJsZVNjcm9sbCgpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5ib2R5UG9ydGFsSG9zdC5oYXNBdHRhY2hlZCgpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmJvZHlQb3J0YWxIb3N0LmRldGFjaCgpO1xuICAgICAgICB0aGlzLnNob3dpbmcgPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICB0aGlzLmhpZGUoKTtcbiAgICAgICAgaWYgKHRoaXMuY2xlYXJJZHMpIHtcbiAgICAgICAgICAgIHRoaXMua2V5Ym9hcmQucmVtb3ZlKHRoaXMuY2xlYXJJZHMpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmNsb3NlS2V5SWRzKSB7XG4gICAgICAgICAgICB0aGlzLmtleWJvYXJkLnJlbW92ZSh0aGlzLmNsb3NlS2V5SWRzKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5zdWJzY3JpcHRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudGltZW91dElkKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0SWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2hvdy9IaWRlIHRoZSBoZWxwIHNjcmVlbiBtYW51YWxseS5cbiAgICAgKi9cbiAgICB0b2dnbGUoKSA6IEtleWJvYXJkU2hvcnRjdXRzSGVscENvbXBvbmVudCB7XG4gICAgICAgIHRoaXMudmlzaWJsZSgpID8gdGhpcy5oaWRlKCkgOiB0aGlzLnJldmVhbCgpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbkxpa2U7XG4gICAgLyoqXG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIHByaXZhdGUgY2xlYXJJZHM7XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSBjbG9zZUtleUlkcztcbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSB0aW1lb3V0SWQ7XG4gICAgLyoqXG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIG5nT25Jbml0KCkge1xuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMua2V5Ym9hcmRIZWxwLnNob3J0Y3V0cyRcbiAgICAgICAgICAgIC5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksIG1hcChzaG9ydGN1dHMgPT4gZ3JvdXBCeShzaG9ydGN1dHMsIFwibGFiZWxcIikpKVxuICAgICAgICAgICAgLnN1YnNjcmliZShzaG9ydGN1dHMgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2hvcnRjdXRzID0gc2hvcnRjdXRzO1xuICAgICAgICAgICAgICAgIHRoaXMubGFiZWxzID0gT2JqZWN0LmtleXMoc2hvcnRjdXRzKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==