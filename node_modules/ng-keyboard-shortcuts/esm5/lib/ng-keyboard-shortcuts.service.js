import * as tslib_1 from "tslib";
import { Injectable } from "@angular/core";
import { _KEYCODE_MAP, _MAP, _SHIFT_MAP, modifiers } from "./keys";
import { BehaviorSubject, fromEvent, Subject, throwError, timer, of } from "rxjs";
import { catchError, filter, map, repeat, scan, switchMap, takeUntil, tap, throttle } from "rxjs/operators";
import { allPass, any, difference, identity, isFunction, isNill, maxArrayProp } from "./utils";
import * as i0 from "@angular/core";
/**
 * @ignore
 * @type {number}
 */
var guid = 0;
var KeyboardShortcutsService = /** @class */ (function () {
    /**
     * @ignore
     */
    function KeyboardShortcutsService() {
        var _this = this;
        /**
         * Parsed shortcuts
         * for each key create a predicate function
         */
        this._shortcuts = [];
        this._sequences = [];
        /**
         * Throttle the keypress event.
         */
        this.throttleTime = 0;
        this._pressed = new Subject();
        /**
         * Streams of pressed events, can be used instead or with a command.
         */
        this.pressed$ = this._pressed.asObservable();
        /**
         * Disable all keyboard shortcuts
         */
        this.disabled = false;
        this._shortcutsSub = new BehaviorSubject([]);
        this.shortcuts$ = this._shortcutsSub
            .asObservable()
            .pipe(filter(function (shortcuts) { return !!shortcuts.length; }));
        this._ignored = ["INPUT", "TEXTAREA", "SELECT"];
        /**
         * @ignore
         * Subscription for on destroy.
         */
        this.subscriptions = [];
        /**
         * @ignore
         * @param shortcut
         */
        this.isAllowed = function (shortcut) {
            var target = shortcut.event.target;
            if (target === shortcut.target) {
                return true;
            }
            if (shortcut.allowIn.length) {
                return !difference(_this._ignored, shortcut.allowIn).includes(target.nodeName);
            }
            return !_this._ignored.includes(target.nodeName);
        };
        /**
         * @ignore
         * @param event
         */
        this.mapEvent = function (event) {
            return _this._shortcuts
                .map(function (shortcut) {
                return Object.assign({}, shortcut, {
                    predicates: any(identity, shortcut.predicates.map(function (predicates) { return allPass(predicates)(event); })),
                    event: event
                });
            })
                .filter(function (shortcut) { return shortcut.predicates; })
                .reduce(function (acc, shortcut) { return (acc.priority > shortcut.priority ? acc : shortcut); }, {
                priority: 0
            });
        };
        /**
         * @ignore
         */
        this.keydown$ = fromEvent(document, "keydown");
        /**
         * @ignore
         */
        this.keydownCombo$ = this.keydown$.pipe(filter(function (_) { return !_this.disabled; }), map(this.mapEvent), filter(function (shortcut) {
            return !shortcut.target || shortcut.event.target === shortcut.target;
        }), filter(function (shortcut) { return isFunction(shortcut.command); }), filter(this.isAllowed), tap(function (shortcut) { return !shortcut.preventDefault || shortcut.event.preventDefault(); }), throttle(function (shortcut) { return timer(shortcut.throttleTime); }), tap(function (shortcut) { return shortcut.command({ event: shortcut.event, key: shortcut.key }); }), tap(function (shortcut) { return _this._pressed.next({ event: shortcut.event, key: shortcut.key }); }), catchError(function (error) { return throwError(error); }));
        /**
         * @ignore
         */
        this.timer$ = new Subject();
        /**
         * @ignore
         */
        this.resetCounter$ = this.timer$
            .asObservable()
            .pipe(switchMap(function () { return timer(KeyboardShortcutsService_1.TIMEOUT_SEQUENCE); }));
        /**
         * @ignore
         */
        this.keydownSequence$ = this.shortcuts$.pipe(map(function (shortcuts) { return shortcuts.filter(function (shortcut) { return shortcut.isSequence; }); }), switchMap(function (sequences) {
            return _this.keydown$.pipe(map(function (event) {
                return {
                    event: event,
                    sequences: sequences
                };
            }), tap(_this.timer$));
        }), scan(function (acc, arg) {
            var event = arg.event;
            var currentLength = acc.events.length;
            var sequences = currentLength ? acc.sequences : arg.sequences;
            var _a = tslib_1.__read(_this.characterFromEvent(event), 1), characters = _a[0];
            characters = Array.isArray(characters) ? characters : [characters];
            var result = sequences
                .map(function (sequence) {
                var sequences = sequence.sequence.filter(function (seque) { return characters.some(function (key) { return seque[currentLength] === key; }); });
                var partialMatch = sequences.length > 0;
                if (sequence.fullMatch) {
                    return sequence;
                }
                return tslib_1.__assign({}, sequence, { sequence: sequences, partialMatch: partialMatch, event: event, fullMatch: partialMatch &&
                        _this.isFullMatch({ command: sequence, events: acc.events }) });
            })
                .filter(function (sequences) { return sequences.partialMatch || sequences.fullMatch; });
            var _b = tslib_1.__read(result, 1), match = _b[0];
            if (!match || _this.modifiersOn(event)) {
                return { events: [], sequences: _this._sequences };
            }
            /*
             * handle case of "?" sequence and "? a" sequence
             * need to determine which one to trigger.
             * if both match, we pick the longer one (? a) in this case.
             */
            var guess = maxArrayProp('priority', result);
            if (result.length > 1 && guess.fullMatch) {
                return { events: [], command: guess, sequences: _this._sequences };
            }
            if (result.length > 1) {
                return { events: tslib_1.__spread(acc.events, [event]), command: result, sequences: result };
            }
            if (match.fullMatch) {
                return { events: [], command: match, sequences: _this._sequences };
            }
            return { events: tslib_1.__spread(acc.events, [event]), command: result, sequences: result };
        }, { events: [], sequences: [] }), switchMap(function (_a) {
            var command = _a.command;
            if (Array.isArray(command)) {
                /*
                 * Add a timer to handle the case where for example:
                 * a sequence "?" is registered and "? a" is registered as well
                 * if the user does not hit any key for 500ms, the single sequence will trigger
                 * if any keydown event occur, this timer will reset, given a chance to complete
                 * the full sequence (? a) in this case.
                 * This delay only occurs when single key sequence is the beginning of another sequence.
                 */
                return timer(500).pipe(map(function () { return ({ command: command.filter(function (command) { return command.fullMatch; })[0] }); }));
            }
            return of({ command: command });
        }), filter(function (_a) {
            var command = _a.command;
            return command && command.fullMatch;
        }), map(function (_a) {
            var command = _a.command;
            return command;
        }), filter(function (shortcut) { return isFunction(shortcut.command); }), filter(this.isAllowed), tap(function (shortcut) { return !shortcut.preventDefault || shortcut.event.preventDefault(); }), throttle(function (shortcut) { return timer(shortcut.throttleTime); }), tap(function (shortcut) { return shortcut.command({ event: shortcut.event, key: shortcut.key }); }), tap(function (shortcut) { return _this._pressed.next({ event: shortcut.event, key: shortcut.key }); }), takeUntil(this.resetCounter$), repeat());
        /**
         * @ignore
         * transforms a shortcut to:
         * a predicate function
         */
        this.getKeys = function (keys) {
            return keys
                .map(function (key) { return key.trim().toLowerCase(); })
                .filter(function (key) { return key !== "+"; })
                .map(function (key) {
                // for modifiers like control key
                // look for event['ctrlKey']
                // otherwise use the keyCode
                if (modifiers.hasOwnProperty(key)) {
                    return function (event) { return !!event[modifiers[key]]; };
                }
                return function (event) {
                    var _a = tslib_1.__read(_this.characterFromEvent(event), 2), characters = _a[0], shiftKey = _a[1];
                    characters = Array.isArray(characters) ? characters : [characters];
                    return characters.some(function (char) {
                        if (char === key && shiftKey) {
                            return true;
                        }
                        return key === char;
                    });
                };
            });
        };
        this.subscriptions.push(this.keydownSequence$.subscribe(), this.keydownCombo$.subscribe());
    }
    KeyboardShortcutsService_1 = KeyboardShortcutsService;
    /**
     * @ignore
     * @param command
     * @param events
     */
    KeyboardShortcutsService.prototype.isFullMatch = function (_a) {
        var command = _a.command, events = _a.events;
        if (!command) {
            return false;
        }
        return command.sequence.some(function (sequence) {
            return sequence.length === events.length + 1;
        });
    };
    Object.defineProperty(KeyboardShortcutsService.prototype, "shortcuts", {
        /**
         * @ignore
         */
        get: function () {
            return this._shortcuts;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @ignore
     * @param event
     */
    KeyboardShortcutsService.prototype._characterFromEvent = function (event) {
        if (typeof event.which !== "number") {
            event.which = event.keyCode;
        }
        // for non keypress events the special maps are needed
        if (_MAP[event.which]) {
            return [_MAP[event.which], event.shiftKey];
        }
        if (_KEYCODE_MAP[event.which]) {
            return [_KEYCODE_MAP[event.which], event.shiftKey];
        }
        // if it is not in the special map
        // with keydown and keyup events the character seems to always
        // come in as an uppercase character whether you are pressing shift
        // or not.  we should make sure it is always lowercase for comparisons
        return [String.fromCharCode(event.which).toLowerCase(), event.shiftKey];
    };
    KeyboardShortcutsService.prototype.characterFromEvent = function (event) {
        var _a = tslib_1.__read(this._characterFromEvent(event), 2), key = _a[0], shiftKey = _a[1];
        if (shiftKey && _SHIFT_MAP[key]) {
            return [_SHIFT_MAP[key], shiftKey];
        }
        return [key, shiftKey];
    };
    /**
     * @ignore
     * Remove subscription.
     */
    KeyboardShortcutsService.prototype.ngOnDestroy = function () {
        this.subscriptions.forEach(function (sub) { return sub.unsubscribe(); });
    };
    /**
     * @ignore
     * @param shortcuts
     */
    KeyboardShortcutsService.prototype.isSequence = function (shortcuts) {
        return !shortcuts.some(function (shortcut) { return shortcut.includes("+"); });
    };
    /**
     * Add new shortcut/s
     */
    KeyboardShortcutsService.prototype.add = function (shortcuts) {
        var _this = this;
        shortcuts = Array.isArray(shortcuts) ? shortcuts : [shortcuts];
        var commands = this.parseCommand(shortcuts);
        commands.forEach(function (command) {
            if (command.isSequence) {
                _this._sequences.push(command);
                return;
            }
            _this._shortcuts.push(command);
        });
        setTimeout(function () {
            _this._shortcutsSub.next(tslib_1.__spread(_this._shortcuts, _this._sequences));
        });
        return commands.map(function (command) { return command.id; });
    };
    /**
     * Remove a command based on key or array of keys.
     * can be used for cleanup.
     * @returns
     * @param ids
     */
    KeyboardShortcutsService.prototype.remove = function (ids) {
        var _this = this;
        ids = Array.isArray(ids) ? ids : [ids];
        this._shortcuts = this._shortcuts.filter(function (shortcut) { return !ids.includes(shortcut.id); });
        this._sequences = this._sequences.filter(function (shortcut) { return !ids.includes(shortcut.id); });
        setTimeout(function () {
            _this._shortcutsSub.next(tslib_1.__spread(_this._shortcuts, _this._sequences));
        });
        return this;
    };
    /**
     * Returns an observable of keyboard shortcut filtered by a specific key.
     * @param key - the key to filter the observable by.
     */
    KeyboardShortcutsService.prototype.select = function (key) {
        return this.pressed$.pipe(filter(function (_a) {
            var event = _a.event, eventKeys = _a.key;
            eventKeys = Array.isArray(eventKeys) ? eventKeys : [eventKeys];
            return !!eventKeys.find(function (eventKey) { return eventKey === key; });
        }));
    };
    /**
     * @ignore
     * @param event
     */
    KeyboardShortcutsService.prototype.modifiersOn = function (event) {
        return ["metaKey", "altKey", "ctrlKey"].some(function (mod) { return event[mod]; });
    };
    /**
     * @ignore
     * Parse each command using getKeys function
     */
    KeyboardShortcutsService.prototype.parseCommand = function (command) {
        var _this = this;
        var commands = Array.isArray(command) ? command : [command];
        return commands.map(function (command) {
            var keys = Array.isArray(command.key) ? command.key : [command.key];
            var priority = Math.max.apply(Math, tslib_1.__spread(keys.map(function (key) { return key.split(" ").filter(identity).length; })));
            var predicates = keys.map(function (key) { return _this.getKeys(key.split(" ").filter(identity)); });
            var isSequence = _this.isSequence(keys);
            var sequence = isSequence
                ? keys.map(function (key) {
                    return key
                        .split(" ")
                        .filter(identity)
                        .map(function (key) { return key.trim(); });
                })
                : [];
            return tslib_1.__assign({}, command, { isSequence: isSequence, sequence: isSequence ? sequence : [], allowIn: command.allowIn || [], key: keys, id: "" + guid++, throttle: isNill(command.throttleTime) ? _this.throttleTime : command.throttleTime, priority: priority, predicates: predicates });
        });
    };
    var KeyboardShortcutsService_1;
    /**
     * @ignore
     * 2000 ms window to allow between key sequences otherwise
     * the sequence will reset.
     */
    KeyboardShortcutsService.TIMEOUT_SEQUENCE = 1000;
    KeyboardShortcutsService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function KeyboardShortcutsService_Factory() { return new KeyboardShortcutsService(); }, token: KeyboardShortcutsService, providedIn: "root" });
    KeyboardShortcutsService = KeyboardShortcutsService_1 = tslib_1.__decorate([
        Injectable({
            providedIn: "root"
        }),
        tslib_1.__metadata("design:paramtypes", [])
    ], KeyboardShortcutsService);
    return KeyboardShortcutsService;
}());
export { KeyboardShortcutsService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmcta2V5Ym9hcmQtc2hvcnRjdXRzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1rZXlib2FyZC1zaG9ydGN1dHMvIiwic291cmNlcyI6WyJsaWIvbmcta2V5Ym9hcmQtc2hvcnRjdXRzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDdEQsT0FBTyxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNuRSxPQUFPLEVBQ0gsZUFBZSxFQUNmLFNBQVMsRUFFVCxPQUFPLEVBRVAsVUFBVSxFQUNWLEtBQUssRUFDTCxFQUFFLEVBQ0wsTUFBTSxNQUFNLENBQUM7QUFNZCxPQUFPLEVBQ0gsVUFBVSxFQUNWLE1BQU0sRUFDTixHQUFHLEVBQ0gsTUFBTSxFQUNOLElBQUksRUFDSixTQUFTLEVBQ1QsU0FBUyxFQUNULEdBQUcsRUFDSCxRQUFRLEVBQ1gsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QixPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sU0FBUyxDQUFDOztBQUUvRjs7O0dBR0c7QUFDSCxJQUFJLElBQUksR0FBRyxDQUFDLENBQUM7QUFLYjtJQXVPSTs7T0FFRztJQUNIO1FBQUEsaUJBRUM7UUEzT0Q7OztXQUdHO1FBQ0ssZUFBVSxHQUFxQixFQUFFLENBQUM7UUFFbEMsZUFBVSxHQUFxQixFQUFFLENBQUM7UUFFMUM7O1dBRUc7UUFDSyxpQkFBWSxHQUFHLENBQUMsQ0FBQztRQUVqQixhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQXVCLENBQUM7UUFFdEQ7O1dBRUc7UUFDSSxhQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUUvQzs7V0FFRztRQUNLLGFBQVEs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IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IF9LRVlDT0RFX01BUCwgX01BUCwgX1NISUZUX01BUCwgbW9kaWZpZXJzIH0gZnJvbSBcIi4va2V5c1wiO1xuaW1wb3J0IHtcbiAgICBCZWhhdmlvclN1YmplY3QsXG4gICAgZnJvbUV2ZW50LFxuICAgIE9ic2VydmFibGUsXG4gICAgU3ViamVjdCxcbiAgICBTdWJzY3JpcHRpb24sXG4gICAgdGhyb3dFcnJvcixcbiAgICB0aW1lcixcbiAgICBvZlxufSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHtcbiAgICBQYXJzZWRTaG9ydGN1dCxcbiAgICBTaG9ydGN1dEV2ZW50T3V0cHV0LFxuICAgIFNob3J0Y3V0SW5wdXRcbn0gZnJvbSBcIi4vbmcta2V5Ym9hcmQtc2hvcnRjdXRzLmludGVyZmFjZXNcIjtcbmltcG9ydCB7XG4gICAgY2F0Y2hFcnJvcixcbiAgICBmaWx0ZXIsXG4gICAgbWFwLFxuICAgIHJlcGVhdCxcbiAgICBzY2FuLFxuICAgIHN3aXRjaE1hcCxcbiAgICB0YWtlVW50aWwsXG4gICAgdGFwLFxuICAgIHRocm90dGxlXG59IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xuaW1wb3J0IHsgYWxsUGFzcywgYW55LCBkaWZmZXJlbmNlLCBpZGVudGl0eSwgaXNGdW5jdGlvbiwgaXNOaWxsLCBtYXhBcnJheVByb3AgfSBmcm9tIFwiLi91dGlsc1wiO1xuXG4vKipcbiAqIEBpZ25vcmVcbiAqIEB0eXBlIHtudW1iZXJ9XG4gKi9cbmxldCBndWlkID0gMDtcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46IFwicm9vdFwiXG59KVxuZXhwb3J0IGNsYXNzIEtleWJvYXJkU2hvcnRjdXRzU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gICAgLyoqXG4gICAgICogUGFyc2VkIHNob3J0Y3V0c1xuICAgICAqIGZvciBlYWNoIGtleSBjcmVhdGUgYSBwcmVkaWNhdGUgZnVuY3Rpb25cbiAgICAgKi9cbiAgICBwcml2YXRlIF9zaG9ydGN1dHM6IFBhcnNlZFNob3J0Y3V0W10gPSBbXTtcblxuICAgIHByaXZhdGUgX3NlcXVlbmNlczogUGFyc2VkU2hvcnRjdXRbXSA9IFtdO1xuXG4gICAgLyoqXG4gICAgICogVGhyb3R0bGUgdGhlIGtleXByZXNzIGV2ZW50LlxuICAgICAqL1xuICAgIHByaXZhdGUgdGhyb3R0bGVUaW1lID0gMDtcblxuICAgIHByaXZhdGUgX3ByZXNzZWQgPSBuZXcgU3ViamVjdDxTaG9ydGN1dEV2ZW50T3V0cHV0PigpO1xuXG4gICAgLyoqXG4gICAgICogU3RyZWFtcyBvZiBwcmVzc2VkIGV2ZW50cywgY2FuIGJlIHVzZWQgaW5zdGVhZCBvciB3aXRoIGEgY29tbWFuZC5cbiAgICAgKi9cbiAgICBwdWJsaWMgcHJlc3NlZCQgPSB0aGlzLl9wcmVzc2VkLmFzT2JzZXJ2YWJsZSgpO1xuXG4gICAgLyoqXG4gICAgICogRGlzYWJsZSBhbGwga2V5Ym9hcmQgc2hvcnRjdXRzXG4gICAgICovXG4gICAgcHJpdmF0ZSBkaXNhYmxlZCA9IGZhbHNlO1xuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKiAyMDAwIG1zIHdpbmRvdyB0byBhbGxvdyBiZXR3ZWVuIGtleSBzZXF1ZW5jZXMgb3RoZXJ3aXNlXG4gICAgICogdGhlIHNlcXVlbmNlIHdpbGwgcmVzZXQuXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgVElNRU9VVF9TRVFVRU5DRSA9IDEwMDA7XG5cbiAgICBwcml2YXRlIF9zaG9ydGN1dHNTdWIgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFBhcnNlZFNob3J0Y3V0W10+KFtdKTtcbiAgICBwdWJsaWMgc2hvcnRjdXRzJCA9IHRoaXMuX3Nob3J0Y3V0c1N1YlxuICAgICAgICAuYXNPYnNlcnZhYmxlKClcbiAgICAgICAgLnBpcGUoZmlsdGVyKHNob3J0Y3V0cyA9PiAhIXNob3J0Y3V0cy5sZW5ndGgpKTtcblxuICAgIHByaXZhdGUgX2lnbm9yZWQgPSBbXCJJTlBVVFwiLCBcIlRFWFRBUkVBXCIsIFwiU0VMRUNUXCJdO1xuXG4gICAgLyoqXG4gICAgICogQGlnbm9yZVxuICAgICAqIFN1YnNjcmlwdGlvbiBmb3Igb24gZGVzdHJveS5cbiAgICAgKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbltdID0gW107XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICogQHBhcmFtIHNob3J0Y3V0XG4gICAgICovXG4gICAgcHJpdmF0ZSBpc0FsbG93ZWQgPSAoc2hvcnRjdXQ6IFBhcnNlZFNob3J0Y3V0KSA9PiB7XG4gICAgICAgIGNvbnN0IHRhcmdldCA9IHNob3J0Y3V0LmV2ZW50LnRhcmdldCBhcyBIVE1MRWxlbWVudDtcbiAgICAgICAgaWYgKHRhcmdldCA9PT0gc2hvcnRjdXQudGFyZ2V0KSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2hvcnRjdXQuYWxsb3dJbi5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiAhZGlmZmVyZW5jZSh0aGlzLl9pZ25vcmVkLCBzaG9ydGN1dC5hbGxvd0luKS5pbmNsdWRlcyh0YXJnZXQubm9kZU5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAhdGhpcy5faWdub3JlZC5pbmNsdWRlcyh0YXJnZXQubm9kZU5hbWUpO1xuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICogQHBhcmFtIGV2ZW50XG4gICAgICovXG4gICAgcHJpdmF0ZSBtYXBFdmVudCA9IGV2ZW50ID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Nob3J0Y3V0c1xuICAgICAgICAgICAgLm1hcChzaG9ydGN1dCA9PlxuICAgICAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oe30sIHNob3J0Y3V0LCB7XG4gICAgICAgICAgICAgICAgICAgIHByZWRpY2F0ZXM6IGFueShcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkZW50aXR5LFxuICAgICAgICAgICAgICAgICAgICAgICAgc2hvcnRjdXQucHJlZGljYXRlcy5tYXAoKHByZWRpY2F0ZXM6IGFueSkgPT4gYWxsUGFzcyhwcmVkaWNhdGVzKShldmVudCkpXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50OiBldmVudFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuZmlsdGVyKHNob3J0Y3V0ID0+IHNob3J0Y3V0LnByZWRpY2F0ZXMpXG4gICAgICAgICAgICAucmVkdWNlKChhY2MsIHNob3J0Y3V0KSA9PiAoYWNjLnByaW9yaXR5ID4gc2hvcnRjdXQucHJpb3JpdHkgPyBhY2MgOiBzaG9ydGN1dCksIHtcbiAgICAgICAgICAgICAgICBwcmlvcml0eTogMFxuICAgICAgICAgICAgfSBhcyBQYXJzZWRTaG9ydGN1dCk7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICBwcml2YXRlIGtleWRvd24kID0gZnJvbUV2ZW50KGRvY3VtZW50LCBcImtleWRvd25cIik7XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSBrZXlkb3duQ29tYm8kID0gdGhpcy5rZXlkb3duJC5waXBlKFxuICAgICAgICBmaWx0ZXIoXyA9PiAhdGhpcy5kaXNhYmxlZCksXG4gICAgICAgIG1hcCh0aGlzLm1hcEV2ZW50KSxcbiAgICAgICAgZmlsdGVyKFxuICAgICAgICAgICAgKHNob3J0Y3V0OiBQYXJzZWRTaG9ydGN1dCkgPT5cbiAgICAgICAgICAgICAgICAhc2hvcnRjdXQudGFyZ2V0IHx8IHNob3J0Y3V0LmV2ZW50LnRhcmdldCA9PT0gc2hvcnRjdXQudGFyZ2V0XG4gICAgICAgICksXG4gICAgICAgIGZpbHRlcigoc2hvcnRjdXQ6IFBhcnNlZFNob3J0Y3V0KSA9PiBpc0Z1bmN0aW9uKHNob3J0Y3V0LmNvbW1hbmQpKSxcbiAgICAgICAgZmlsdGVyKHRoaXMuaXNBbGxvd2VkKSxcbiAgICAgICAgdGFwKHNob3J0Y3V0ID0+ICFzaG9ydGN1dC5wcmV2ZW50RGVmYXVsdCB8fCBzaG9ydGN1dC5ldmVudC5wcmV2ZW50RGVmYXVsdCgpKSxcbiAgICAgICAgdGhyb3R0bGUoc2hvcnRjdXQgPT4gdGltZXIoc2hvcnRjdXQudGhyb3R0bGVUaW1lKSksXG4gICAgICAgIHRhcChzaG9ydGN1dCA9PiBzaG9ydGN1dC5jb21tYW5kKHsgZXZlbnQ6IHNob3J0Y3V0LmV2ZW50LCBrZXk6IHNob3J0Y3V0LmtleSB9KSksXG4gICAgICAgIHRhcChzaG9ydGN1dCA9PiB0aGlzLl9wcmVzc2VkLm5leHQoeyBldmVudDogc2hvcnRjdXQuZXZlbnQsIGtleTogc2hvcnRjdXQua2V5IH0pKSxcbiAgICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB0aHJvd0Vycm9yKGVycm9yKSlcbiAgICApO1xuXG4gICAgLyoqXG4gICAgICogQGlnbm9yZVxuICAgICAqL1xuICAgIHByaXZhdGUgdGltZXIkID0gbmV3IFN1YmplY3QoKTtcbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSByZXNldENvdW50ZXIkID0gdGhpcy50aW1lciRcbiAgICAgICAgLmFzT2JzZXJ2YWJsZSgpXG4gICAgICAgIC5waXBlKHN3aXRjaE1hcCgoKSA9PiB0aW1lcihLZXlib2FyZFNob3J0Y3V0c1NlcnZpY2UuVElNRU9VVF9TRVFVRU5DRSkpKTtcbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSBrZXlkb3duU2VxdWVuY2UkID0gdGhpcy5zaG9ydGN1dHMkLnBpcGUoXG4gICAgICAgIG1hcChzaG9ydGN1dHMgPT4gc2hvcnRjdXRzLmZpbHRlcihzaG9ydGN1dCA9PiBzaG9ydGN1dC5pc1NlcXVlbmNlKSksXG4gICAgICAgIHN3aXRjaE1hcChzZXF1ZW5jZXMgPT5cbiAgICAgICAgICAgIHRoaXMua2V5ZG93biQucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXF1ZW5jZXNcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICB0YXAodGhpcy50aW1lciQpXG4gICAgICAgICAgICApXG4gICAgICAgICksXG4gICAgICAgIHNjYW4oXG4gICAgICAgICAgICAoYWNjOiB7IGV2ZW50czogYW55W107IGNvbW1hbmQ/OiBhbnk7IHNlcXVlbmNlczogYW55W10gfSwgYXJnOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgeyBldmVudCB9ID0gYXJnO1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRMZW5ndGggPSBhY2MuZXZlbnRzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICBjb25zdCBzZXF1ZW5jZXMgPSBjdXJyZW50TGVuZ3RoID8gYWNjLnNlcXVlbmNlcyA6IGFyZy5zZXF1ZW5jZXM7XG4gICAgICAgICAgICAgICAgbGV0IFtjaGFyYWN0ZXJzXSA9IHRoaXMuY2hhcmFjdGVyRnJvbUV2ZW50KGV2ZW50KTtcbiAgICAgICAgICAgICAgICBjaGFyYWN0ZXJzID0gQXJyYXkuaXNBcnJheShjaGFyYWN0ZXJzKSA/IGNoYXJhY3RlcnMgOiBbY2hhcmFjdGVyc107XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gc2VxdWVuY2VzXG4gICAgICAgICAgICAgICAgICAgIC5tYXAoc2VxdWVuY2UgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VxdWVuY2VzID0gc2VxdWVuY2Uuc2VxdWVuY2UuZmlsdGVyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcXVlID0+IGNoYXJhY3RlcnMuc29tZSgoa2V5KSA9PiBzZXF1ZVtjdXJyZW50TGVuZ3RoXSA9PT0ga2V5KVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcnRpYWxNYXRjaCA9IHNlcXVlbmNlcy5sZW5ndGggPiAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlcXVlbmNlLmZ1bGxNYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZXF1ZW5jZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uc2VxdWVuY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VxdWVuY2U6IHNlcXVlbmNlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0aWFsTWF0Y2gsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxNYXRjaDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbE1hdGNoICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXNGdWxsTWF0Y2goeyBjb21tYW5kOiBzZXF1ZW5jZSwgZXZlbnRzOiBhY2MuZXZlbnRzIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKHNlcXVlbmNlcyA9PiBzZXF1ZW5jZXMucGFydGlhbE1hdGNoIHx8IHNlcXVlbmNlcy5mdWxsTWF0Y2gpO1xuXG4gICAgICAgICAgICAgICAgbGV0IFttYXRjaF0gPSByZXN1bHQ7XG4gICAgICAgICAgICAgICAgaWYgKCFtYXRjaCB8fCB0aGlzLm1vZGlmaWVyc09uKGV2ZW50KSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBldmVudHM6IFtdLCBzZXF1ZW5jZXM6IHRoaXMuX3NlcXVlbmNlcyB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgICAqIGhhbmRsZSBjYXNlIG9mIFwiP1wiIHNlcXVlbmNlIGFuZCBcIj8gYVwiIHNlcXVlbmNlXG4gICAgICAgICAgICAgICAgICogbmVlZCB0byBkZXRlcm1pbmUgd2hpY2ggb25lIHRvIHRyaWdnZXIuXG4gICAgICAgICAgICAgICAgICogaWYgYm90aCBtYXRjaCwgd2UgcGljayB0aGUgbG9uZ2VyIG9uZSAoPyBhKSBpbiB0aGlzIGNhc2UuXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgY29uc3QgZ3Vlc3MgPSBtYXhBcnJheVByb3AoJ3ByaW9yaXR5JywgcmVzdWx0KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDEgJiYgZ3Vlc3MuZnVsbE1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7IGV2ZW50czogW10sIGNvbW1hbmQ6IGd1ZXNzLCBzZXF1ZW5jZXM6IHRoaXMuX3NlcXVlbmNlcyB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgZXZlbnRzOiBbLi4uYWNjLmV2ZW50cywgZXZlbnRdLCBjb21tYW5kOiByZXN1bHQsIHNlcXVlbmNlczogcmVzdWx0IH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChtYXRjaC5mdWxsTWF0Y2gpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgZXZlbnRzOiBbXSwgY29tbWFuZDogbWF0Y2gsIHNlcXVlbmNlczogdGhpcy5fc2VxdWVuY2VzIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB7IGV2ZW50czogWy4uLmFjYy5ldmVudHMsIGV2ZW50XSwgY29tbWFuZDogcmVzdWx0LCBzZXF1ZW5jZXM6IHJlc3VsdCB9O1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHsgZXZlbnRzOiBbXSwgc2VxdWVuY2VzOiBbXSB9XG4gICAgICAgICksXG4gICAgICAgIHN3aXRjaE1hcCgoeyBjb21tYW5kIH0pID0+IHtcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbW1hbmQpKSB7XG4gICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICAgKiBBZGQgYSB0aW1lciB0byBoYW5kbGUgdGhlIGNhc2Ugd2hlcmUgZm9yIGV4YW1wbGU6XG4gICAgICAgICAgICAgICAgICogYSBzZXF1ZW5jZSBcIj9cIiBpcyByZWdpc3RlcmVkIGFuZCBcIj8gYVwiIGlzIHJlZ2lzdGVyZWQgYXMgd2VsbFxuICAgICAgICAgICAgICAgICAqIGlmIHRoZSB1c2VyIGRvZXMgbm90IGhpdCBhbnkga2V5IGZvciA1MDBtcywgdGhlIHNpbmdsZSBzZXF1ZW5jZSB3aWxsIHRyaWdnZXJcbiAgICAgICAgICAgICAgICAgKiBpZiBhbnkga2V5ZG93biBldmVudCBvY2N1ciwgdGhpcyB0aW1lciB3aWxsIHJlc2V0LCBnaXZlbiBhIGNoYW5jZSB0byBjb21wbGV0ZVxuICAgICAgICAgICAgICAgICAqIHRoZSBmdWxsIHNlcXVlbmNlICg/IGEpIGluIHRoaXMgY2FzZS5cbiAgICAgICAgICAgICAgICAgKiBUaGlzIGRlbGF5IG9ubHkgb2NjdXJzIHdoZW4gc2luZ2xlIGtleSBzZXF1ZW5jZSBpcyB0aGUgYmVnaW5uaW5nIG9mIGFub3RoZXIgc2VxdWVuY2UuXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRpbWVyKDUwMCkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgbWFwKCgpID0+ICh7IGNvbW1hbmQ6IGNvbW1hbmQuZmlsdGVyKGNvbW1hbmQgPT4gY29tbWFuZC5mdWxsTWF0Y2gpWzBdIH0pKSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG9mKHsgY29tbWFuZCB9KTtcbiAgICAgICAgfSksXG4gICAgICAgIGZpbHRlcigoeyBjb21tYW5kIH0pID0+IGNvbW1hbmQgJiYgY29tbWFuZC5mdWxsTWF0Y2gpLFxuICAgICAgICBtYXAoKHsgY29tbWFuZCB9KSA9PiBjb21tYW5kKSxcbiAgICAgICAgZmlsdGVyKChzaG9ydGN1dDogUGFyc2VkU2hvcnRjdXQpID0+IGlzRnVuY3Rpb24oc2hvcnRjdXQuY29tbWFuZCkpLFxuICAgICAgICBmaWx0ZXIodGhpcy5pc0FsbG93ZWQpLFxuICAgICAgICB0YXAoc2hvcnRjdXQgPT4gIXNob3J0Y3V0LnByZXZlbnREZWZhdWx0IHx8IHNob3J0Y3V0LmV2ZW50LnByZXZlbnREZWZhdWx0KCkpLFxuICAgICAgICB0aHJvdHRsZShzaG9ydGN1dCA9PiB0aW1lcihzaG9ydGN1dC50aHJvdHRsZVRpbWUpKSxcbiAgICAgICAgdGFwKHNob3J0Y3V0ID0+IHNob3J0Y3V0LmNvbW1hbmQoeyBldmVudDogc2hvcnRjdXQuZXZlbnQsIGtleTogc2hvcnRjdXQua2V5IH0pKSxcbiAgICAgICAgdGFwKHNob3J0Y3V0ID0+IHRoaXMuX3ByZXNzZWQubmV4dCh7IGV2ZW50OiBzaG9ydGN1dC5ldmVudCwga2V5OiBzaG9ydGN1dC5rZXkgfSkpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5yZXNldENvdW50ZXIkKSxcbiAgICAgICAgcmVwZWF0KClcbiAgICApO1xuXG4gICAgLyoqXG4gICAgICogQGlnbm9yZVxuICAgICAqIEBwYXJhbSBjb21tYW5kXG4gICAgICogQHBhcmFtIGV2ZW50c1xuICAgICAqL1xuICAgIHByaXZhdGUgaXNGdWxsTWF0Y2goeyBjb21tYW5kLCBldmVudHMgfSkge1xuICAgICAgICBpZiAoIWNvbW1hbmQpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29tbWFuZC5zZXF1ZW5jZS5zb21lKHNlcXVlbmNlID0+IHtcbiAgICAgICAgICAgIHJldHVybiBzZXF1ZW5jZS5sZW5ndGggPT09IGV2ZW50cy5sZW5ndGggKyAxO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXQgc2hvcnRjdXRzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fc2hvcnRjdXRzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2godGhpcy5rZXlkb3duU2VxdWVuY2UkLnN1YnNjcmliZSgpLCB0aGlzLmtleWRvd25Db21ibyQuc3Vic2NyaWJlKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKiBAcGFyYW0gZXZlbnRcbiAgICAgKi9cbiAgICBwcml2YXRlIF9jaGFyYWN0ZXJGcm9tRXZlbnQoZXZlbnQpOiBbc3RyaW5nLCBib29sZWFuXSB7XG4gICAgICAgIGlmICh0eXBlb2YgZXZlbnQud2hpY2ggIT09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgICAgIGV2ZW50LndoaWNoID0gZXZlbnQua2V5Q29kZTtcbiAgICAgICAgfVxuICAgICAgICAvLyBmb3Igbm9uIGtleXByZXNzIGV2ZW50cyB0aGUgc3BlY2lhbCBtYXBzIGFyZSBuZWVkZWRcbiAgICAgICAgaWYgKF9NQVBbZXZlbnQud2hpY2hdKSB7XG4gICAgICAgICAgICByZXR1cm4gW19NQVBbZXZlbnQud2hpY2hdLCBldmVudC5zaGlmdEtleV07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoX0tFWUNPREVfTUFQW2V2ZW50LndoaWNoXSkge1xuICAgICAgICAgICAgcmV0dXJuIFtfS0VZQ09ERV9NQVBbZXZlbnQud2hpY2hdLCBldmVudC5zaGlmdEtleV07XG4gICAgICAgIH1cbiAgICAgICAgLy8gaWYgaXQgaXMgbm90IGluIHRoZSBzcGVjaWFsIG1hcFxuXG4gICAgICAgIC8vIHdpdGgga2V5ZG93biBhbmQga2V5dXAgZXZlbnRzIHRoZSBjaGFyYWN0ZXIgc2VlbXMgdG8gYWx3YXlzXG4gICAgICAgIC8vIGNvbWUgaW4gYXMgYW4gdXBwZXJjYXNlIGNoYXJhY3RlciB3aGV0aGVyIHlvdSBhcmUgcHJlc3Npbmcgc2hpZnRcbiAgICAgICAgLy8gb3Igbm90LiAgd2Ugc2hvdWxkIG1ha2Ugc3VyZSBpdCBpcyBhbHdheXMgbG93ZXJjYXNlIGZvciBjb21wYXJpc29uc1xuICAgICAgICByZXR1cm4gW1N0cmluZy5mcm9tQ2hhckNvZGUoZXZlbnQud2hpY2gpLnRvTG93ZXJDYXNlKCksIGV2ZW50LnNoaWZ0S2V5XTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNoYXJhY3RlckZyb21FdmVudChldmVudCkge1xuICAgICAgICBsZXQgW2tleSwgc2hpZnRLZXldID0gdGhpcy5fY2hhcmFjdGVyRnJvbUV2ZW50KGV2ZW50KTtcbiAgICAgICAgaWYgKHNoaWZ0S2V5ICYmIF9TSElGVF9NQVBba2V5XSkge1xuICAgICAgICAgICAgcmV0dXJuIFtfU0hJRlRfTUFQW2tleV0sIHNoaWZ0S2V5XTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW2tleSwgc2hpZnRLZXldO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKiBSZW1vdmUgc3Vic2NyaXB0aW9uLlxuICAgICAqL1xuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZm9yRWFjaChzdWIgPT4gc3ViLnVuc3Vic2NyaWJlKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKiBAcGFyYW0gc2hvcnRjdXRzXG4gICAgICovXG4gICAgcHJpdmF0ZSBpc1NlcXVlbmNlKHNob3J0Y3V0czogc3RyaW5nW10pOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuICFzaG9ydGN1dHMuc29tZShzaG9ydGN1dCA9PiBzaG9ydGN1dC5pbmNsdWRlcyhcIitcIikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZCBuZXcgc2hvcnRjdXQvc1xuICAgICAqL1xuICAgIHB1YmxpYyBhZGQoc2hvcnRjdXRzOiBTaG9ydGN1dElucHV0W10gfCBTaG9ydGN1dElucHV0KTogc3RyaW5nW10ge1xuICAgICAgICBzaG9ydGN1dHMgPSBBcnJheS5pc0FycmF5KHNob3J0Y3V0cykgPyBzaG9ydGN1dHMgOiBbc2hvcnRjdXRzXTtcbiAgICAgICAgY29uc3QgY29tbWFuZHMgPSB0aGlzLnBhcnNlQ29tbWFuZChzaG9ydGN1dHMpO1xuICAgICAgICBjb21tYW5kcy5mb3JFYWNoKGNvbW1hbmQgPT4ge1xuICAgICAgICAgICAgaWYgKGNvbW1hbmQuaXNTZXF1ZW5jZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3NlcXVlbmNlcy5wdXNoKGNvbW1hbmQpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX3Nob3J0Y3V0cy5wdXNoKGNvbW1hbmQpO1xuICAgICAgICB9KTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9zaG9ydGN1dHNTdWIubmV4dChbLi4udGhpcy5fc2hvcnRjdXRzLCAuLi50aGlzLl9zZXF1ZW5jZXNdKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBjb21tYW5kcy5tYXAoY29tbWFuZCA9PiBjb21tYW5kLmlkKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYSBjb21tYW5kIGJhc2VkIG9uIGtleSBvciBhcnJheSBvZiBrZXlzLlxuICAgICAqIGNhbiBiZSB1c2VkIGZvciBjbGVhbnVwLlxuICAgICAqIEByZXR1cm5zXG4gICAgICogQHBhcmFtIGlkc1xuICAgICAqL1xuICAgIHB1YmxpYyByZW1vdmUoaWRzOiBzdHJpbmcgfCBzdHJpbmdbXSk6IEtleWJvYXJkU2hvcnRjdXRzU2VydmljZSB7XG4gICAgICAgIGlkcyA9IEFycmF5LmlzQXJyYXkoaWRzKSA/IGlkcyA6IFtpZHNdO1xuICAgICAgICB0aGlzLl9zaG9ydGN1dHMgPSB0aGlzLl9zaG9ydGN1dHMuZmlsdGVyKHNob3J0Y3V0ID0+ICFpZHMuaW5jbHVkZXMoc2hvcnRjdXQuaWQpKTtcbiAgICAgICAgdGhpcy5fc2VxdWVuY2VzID0gdGhpcy5fc2VxdWVuY2VzLmZpbHRlcihzaG9ydGN1dCA9PiAhaWRzLmluY2x1ZGVzKHNob3J0Y3V0LmlkKSk7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fc2hvcnRjdXRzU3ViLm5leHQoWy4uLnRoaXMuX3Nob3J0Y3V0cywgLi4udGhpcy5fc2VxdWVuY2VzXSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGFuIG9ic2VydmFibGUgb2Yga2V5Ym9hcmQgc2hvcnRjdXQgZmlsdGVyZWQgYnkgYSBzcGVjaWZpYyBrZXkuXG4gICAgICogQHBhcmFtIGtleSAtIHRoZSBrZXkgdG8gZmlsdGVyIHRoZSBvYnNlcnZhYmxlIGJ5LlxuICAgICAqL1xuICAgIHB1YmxpYyBzZWxlY3Qoa2V5OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFNob3J0Y3V0RXZlbnRPdXRwdXQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJlc3NlZCQucGlwZShcbiAgICAgICAgICAgIGZpbHRlcigoeyBldmVudCwga2V5OiBldmVudEtleXMgfSkgPT4ge1xuICAgICAgICAgICAgICAgIGV2ZW50S2V5cyA9IEFycmF5LmlzQXJyYXkoZXZlbnRLZXlzKSA/IGV2ZW50S2V5cyA6IFtldmVudEtleXNdO1xuICAgICAgICAgICAgICAgIHJldHVybiAhIWV2ZW50S2V5cy5maW5kKGV2ZW50S2V5ID0+IGV2ZW50S2V5ID09PSBrZXkpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICogdHJhbnNmb3JtcyBhIHNob3J0Y3V0IHRvOlxuICAgICAqIGEgcHJlZGljYXRlIGZ1bmN0aW9uXG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXRLZXlzID0gKGtleXM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICAgIHJldHVybiBrZXlzXG4gICAgICAgICAgICAubWFwKGtleSA9PiBrZXkudHJpbSgpLnRvTG93ZXJDYXNlKCkpXG4gICAgICAgICAgICAuZmlsdGVyKGtleSA9PiBrZXkgIT09IFwiK1wiKVxuICAgICAgICAgICAgLm1hcChrZXkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIGZvciBtb2RpZmllcnMgbGlrZSBjb250cm9sIGtleVxuICAgICAgICAgICAgICAgIC8vIGxvb2sgZm9yIGV2ZW50WydjdHJsS2V5J11cbiAgICAgICAgICAgICAgICAvLyBvdGhlcndpc2UgdXNlIHRoZSBrZXlDb2RlXG4gICAgICAgICAgICAgICAgaWYgKG1vZGlmaWVycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudCA9PiAhIWV2ZW50W21vZGlmaWVyc1trZXldXTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsZXQgW2NoYXJhY3RlcnMsIHNoaWZ0S2V5XSA9IHRoaXMuY2hhcmFjdGVyRnJvbUV2ZW50KGV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgY2hhcmFjdGVycyA9IEFycmF5LmlzQXJyYXkoY2hhcmFjdGVycykgPyBjaGFyYWN0ZXJzIDogW2NoYXJhY3RlcnNdO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hhcmFjdGVycy5zb21lKGNoYXIgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoYXIgPT09IGtleSAmJiBzaGlmdEtleSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGtleSA9PT0gY2hhcjtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBpZ25vcmVcbiAgICAgKiBAcGFyYW0gZXZlbnRcbiAgICAgKi9cbiAgICBwcml2YXRlIG1vZGlmaWVyc09uKGV2ZW50KSB7XG4gICAgICAgIHJldHVybiBbXCJtZXRhS2V5XCIsIFwiYWx0S2V5XCIsIFwiY3RybEtleVwiXS5zb21lKG1vZCA9PiBldmVudFttb2RdKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAaWdub3JlXG4gICAgICogUGFyc2UgZWFjaCBjb21tYW5kIHVzaW5nIGdldEtleXMgZnVuY3Rpb25cbiAgICAgKi9cbiAgICBwcml2YXRlIHBhcnNlQ29tbWFuZChjb21tYW5kOiBTaG9ydGN1dElucHV0IHwgU2hvcnRjdXRJbnB1dFtdKTogUGFyc2VkU2hvcnRjdXRbXSB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmRzID0gQXJyYXkuaXNBcnJheShjb21tYW5kKSA/IGNvbW1hbmQgOiBbY29tbWFuZF07XG4gICAgICAgIHJldHVybiBjb21tYW5kcy5tYXAoY29tbWFuZCA9PiB7XG4gICAgICAgICAgICBjb25zdCBrZXlzID0gQXJyYXkuaXNBcnJheShjb21tYW5kLmtleSkgPyBjb21tYW5kLmtleSA6IFtjb21tYW5kLmtleV07XG4gICAgICAgICAgICBjb25zdCBwcmlvcml0eSA9IE1hdGgubWF4KC4uLmtleXMubWFwKGtleSA9PiBrZXkuc3BsaXQoXCIgXCIpLmZpbHRlcihpZGVudGl0eSkubGVuZ3RoKSk7XG4gICAgICAgICAgICBjb25zdCBwcmVkaWNhdGVzID0ga2V5cy5tYXAoa2V5ID0+IHRoaXMuZ2V0S2V5cyhrZXkuc3BsaXQoXCIgXCIpLmZpbHRlcihpZGVudGl0eSkpKTtcbiAgICAgICAgICAgIGNvbnN0IGlzU2VxdWVuY2UgPSB0aGlzLmlzU2VxdWVuY2Uoa2V5cyk7XG4gICAgICAgICAgICBjb25zdCBzZXF1ZW5jZSA9IGlzU2VxdWVuY2VcbiAgICAgICAgICAgICAgICA/IGtleXMubWFwKGtleSA9PlxuICAgICAgICAgICAgICAgICAgICAgIGtleVxuICAgICAgICAgICAgICAgICAgICAgICAgICAuc3BsaXQoXCIgXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoaWRlbnRpdHkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoa2V5ID0+IGtleS50cmltKCkpXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgOiBbXTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgLi4uY29tbWFuZCxcbiAgICAgICAgICAgICAgICBpc1NlcXVlbmNlLFxuICAgICAgICAgICAgICAgIHNlcXVlbmNlOiBpc1NlcXVlbmNlID8gc2VxdWVuY2UgOiBbXSxcbiAgICAgICAgICAgICAgICBhbGxvd0luOiBjb21tYW5kLmFsbG93SW4gfHwgW10sXG4gICAgICAgICAgICAgICAga2V5OiBrZXlzLFxuICAgICAgICAgICAgICAgIGlkOiBgJHtndWlkKyt9YCxcbiAgICAgICAgICAgICAgICB0aHJvdHRsZTogaXNOaWxsKGNvbW1hbmQudGhyb3R0bGVUaW1lKSA/IHRoaXMudGhyb3R0bGVUaW1lIDogY29tbWFuZC50aHJvdHRsZVRpbWUsXG4gICAgICAgICAgICAgICAgcHJpb3JpdHk6IHByaW9yaXR5LFxuICAgICAgICAgICAgICAgIHByZWRpY2F0ZXM6IHByZWRpY2F0ZXNcbiAgICAgICAgICAgIH0gYXMgUGFyc2VkU2hvcnRjdXQ7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==